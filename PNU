import pandas as pd
import os


# PNUì˜ ë’· 9ìë¦¬ë¥¼ ë¶„ì„í•˜ì—¬ ì§€ë²ˆ ë¬¸ìì—´ì„ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
def parse_pnu_jibun(pnu_suffix):
    """
    PNU ì½”ë“œì˜ ë’· 9ìë¦¬(í† ì§€êµ¬ë¶„, ë³¸ë²ˆ 4ìë¦¬, ë¶€ë²ˆ 4ìë¦¬)ë¥¼ ë¶„ì„í•˜ì—¬ ì§€ë²ˆ ë¬¸ìì—´ì„ ìƒì„±í•©ë‹ˆë‹¤.
    """
    if len(pnu_suffix) != 9:
        return ""

    land_type = pnu_suffix[0]  # 1: ì¼ë°˜, 2: ì‚°
    bon_bun_str = pnu_suffix[1:5]  # ë³¸ë²ˆ 4ìë¦¬
    bu_bun_str = pnu_suffix[5:9]  # ë¶€ë²ˆ 4ìë¦¬

    # 1. í† ì§€ êµ¬ë¶„ ì ‘ë‘ì‚¬ ì²˜ë¦¬
    land_prefix = "ì‚° " if land_type == '2' else ""

    # 2. ë³¸ë²ˆê³¼ ë¶€ë²ˆ íŒŒì‹±
    # '0012'ëŠ” 12ë¡œ, '0000'ì€ 0ìœ¼ë¡œ ë³€í™˜
    bon_bun = int(bon_bun_str)
    bu_bun = int(bu_bun_str)

    # 3. ì§€ë²ˆ ì¡°í•©
    jibun = str(bon_bun)
    if bu_bun > 0:
        jibun += f"-{bu_bun}"

    return land_prefix + jibun


def pnu_to_address_converter_v2(input_file_name, map_file_name, output_file_name, pnu_column_name, map_pnu_column,
                                map_address_column):
    """
    PNU ì½”ë“œì˜ ì• 10ìë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ë²•ì •ë™ëª…ì„ ë§¤í•‘í•˜ê³ , ë‚˜ë¨¸ì§€ 9ìë¦¬ë¥¼ íŒŒì‹±í•˜ì—¬ ì£¼ì†Œë¥¼ ì™„ì„±í•©ë‹ˆë‹¤.

    :param input_file_name: PNU ì½”ë“œê°€ í¬í•¨ëœ ì‚¬ìš©ì ì…ë ¥ CSV íŒŒì¼ ì´ë¦„ ('1.csv')
    :param map_file_name: ë²•ì •ë™ ì½”ë“œ ë§¤í•‘ ì •ë³´ íŒŒì¼ ì´ë¦„ ('êµ­í† êµí†µë¶€_ë²•ì •ë™ì½”ë“œ_20240805.csv')
    :param output_file_name: ë³€í™˜ëœ ê²°ê³¼ê°€ ì €ì¥ë  CSV íŒŒì¼ ì´ë¦„ ('2.csv')
    :param pnu_column_name: ì…ë ¥ íŒŒì¼ì—ì„œ PNU ì½”ë“œê°€ ìˆëŠ” ì»¬ëŸ¼ ì´ë¦„ (ì˜ˆ: 'PNU')
    :param map_pnu_column: ë§¤í•‘ íŒŒì¼ì—ì„œ ë²•ì •ë™ ì½”ë“œê°€ ìˆëŠ” ì»¬ëŸ¼ ì´ë¦„ (ì˜ˆ: 'ë²•ì •ë™ì½”ë“œ')
    :param map_address_column: ë§¤í•‘ íŒŒì¼ì—ì„œ ë²•ì •ë™ëª…ì´ ìˆëŠ” ì»¬ëŸ¼ ì´ë¦„ (ì˜ˆ: 'ë²•ì •ë™ëª…')
    """
    print("--- PNU ì£¼ì†Œ ì¶”ì¶œ ì‘ì—… ì‹œì‘ ---")

    # íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ (ìƒëµ)

    try:
        # 1. ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ë° PNU ì „ì²˜ë¦¬
        input_df = pd.read_csv(input_file_name)

        # PNU ì½”ë“œë¥¼ ë¬¸ìì—´ë¡œ í™•ì •í•˜ê³  ê¸¸ì´ê°€ 19ìë¦¬ì¸ì§€ í™•ì¸
        input_df[pnu_column_name] = input_df[pnu_column_name].astype(str).str.zfill(19)

        # PNU ì½”ë“œì—ì„œ ì• 10ìë¦¬(ë²•ì •ë™ì½”ë“œ)ì™€ ë’· 9ìë¦¬(ì§€ë²ˆ) ë¶„ë¦¬
        input_df['ë²•ì •ë™ì½”ë“œ_10ìë¦¬'] = input_df[pnu_column_name].str.slice(0, 10)
        input_df['PNU_ì§€ë²ˆ_9ìë¦¬'] = input_df[pnu_column_name].str.slice(10, 19)

        # 2. ë²•ì •ë™ ì½”ë“œ ë§¤í•‘ íŒŒì¼ ë¡œë“œ
        address_map_df = pd.read_csv(
            map_file_name,
            dtype={map_pnu_column: str},
            encoding='euc-kr'
        )

        # ë§¤í•‘ íŒŒì¼ì˜ ë²•ì •ë™ ì½”ë“œë¥¼ 10ìë¦¬ë¡œ ì‚¬ìš©
        address_map_df[map_pnu_column] = address_map_df[map_pnu_column].str.slice(0, 10)

        print(f"âœ… ì…ë ¥ íŒŒì¼ ({input_file_name}) ë¡œë“œ ì™„ë£Œ. (ì´ {len(input_df)}ê±´)")
        print(f"âœ… ë²•ì •ë™ ë§¤í•‘ íŒŒì¼ ({map_file_name}) ë¡œë“œ ì™„ë£Œ. (ì´ {len(address_map_df)}ê±´)")

        # 3. ë²•ì •ë™ ì½”ë“œ(10ìë¦¬)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë³‘í•©
        merged_df = pd.merge(
            input_df,
            address_map_df,
            left_on='ë²•ì •ë™ì½”ë“œ_10ìë¦¬',
            right_on=map_pnu_column,
            how='left'
        )

        print(f"âœ… ë²•ì •ë™ ì½”ë“œ ê¸°ì¤€ ë°ì´í„° ë³‘í•© ì™„ë£Œ.")

        # 4. ìµœì¢… ì£¼ì†Œ ì¡°í•© (ë²•ì •ë™ëª… + ì§€ë²ˆ)
        # apply í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ PNU_ì§€ë²ˆ_9ìë¦¬ë¥¼ ì§€ë²ˆ ë¬¸ìì—´ë¡œ ë³€í™˜
        merged_df['ì§€ë²ˆ_ë¬¸ìì—´'] = merged_df['PNU_ì§€ë²ˆ_9ìë¦¬'].apply(parse_pnu_jibun)

        # ë²•ì •ë™ëª…ê³¼ ì§€ë²ˆ ë¬¸ìì—´ì„ ê²°í•©í•˜ì—¬ ìµœì¢… ì£¼ì†Œ ì»¬ëŸ¼ ìƒì„±
        merged_df['ìµœì¢…_ì§€ë²ˆì£¼ì†Œ'] = merged_df[map_address_column].fillna('ì£¼ì†Œ_ë§¤í•‘ì‹¤íŒ¨') + ' ' + merged_df['ì§€ë²ˆ_ë¬¸ìì—´']

        # 5. ë¶ˆí•„ìš”í•œ ì„ì‹œ ì»¬ëŸ¼ ì œê±° ë° ê²°ê³¼ ì €ì¥
        merged_df = merged_df.drop(columns=['ë²•ì •ë™ì½”ë“œ_10ìë¦¬', 'PNU_ì§€ë²ˆ_9ìë¦¬', 'ì§€ë²ˆ_ë¬¸ìì—´', map_pnu_column])

        merged_df.to_csv(output_file_name, index=False, encoding='utf-8-sig')

        print("\n--- ì‘ì—… ì™„ë£Œ ---")
        print(f"ğŸ‰ ì£¼ì†Œê°€ ì¶”ì¶œëœ íŒŒì¼ì´ **'{output_file_name}'**ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
        print("ê²°ê³¼ íŒŒì¼ì˜ ì¼ë¶€ ë‚´ìš© (ìµœì¢…_ì§€ë²ˆì£¼ì†Œ ì»¬ëŸ¼ í™•ì¸):")
        print(merged_df[['PNU', 'ìµœì¢…_ì§€ë²ˆì£¼ì†Œ']].head())

    except KeyError as e:
        print(f"âŒ ì˜¤ë¥˜: ì»¬ëŸ¼ ì´ë¦„ ì˜¤ë¥˜ - {e}ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì»¬ëŸ¼ ì´ë¦„ì„ ì •í™•íˆ í™•ì¸í•´ì£¼ì„¸ìš”.")
    except Exception as e:
        print(f"âŒ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ ë°œìƒ: {e}")


# ==============================================================================
# â¬‡ï¸ ì‚¬ìš©ì ì„¤ì • ë¶€ë¶„ (ìš”ì²­í•˜ì‹  ê°’ìœ¼ë¡œ ë³€ê²½) â¬‡ï¸
# ==============================================================================

# 1. PNU ì½”ë“œê°€ ë“¤ì–´ìˆëŠ” ì‚¬ìš©ìì˜ ì…ë ¥ íŒŒì¼ ì´ë¦„
INPUT_FILE = '1.csv'

# 2. ì „êµ­ ë²•ì •ë™ ë§¤í•‘ DB íŒŒì¼ ì´ë¦„
MAP_FILE = 'êµ­í† êµí†µë¶€_ë²•ì •ë™ì½”ë“œ_20240805.csv'

# 3. ìµœì¢… ê²°ê³¼ë¬¼ì´ ì €ì¥ë  íŒŒì¼ ì´ë¦„
OUTPUT_FILE = '2.csv'

# 4. ì…ë ¥ íŒŒì¼('1.csv')ì—ì„œ PNU ì½”ë“œê°€ ë“¤ì–´ìˆëŠ” ì»¬ëŸ¼ ì´ë¦„
PNU_COLUMN = 'PNU'

# 5. ë§¤í•‘ íŒŒì¼('êµ­í† êµí†µë¶€...')ì—ì„œ ë²•ì •ë™ ì½”ë“œê°€ ìˆëŠ” ì»¬ëŸ¼ ì´ë¦„
MAP_PNU_COLUMN = 'ë²•ì •ë™ì½”ë“œ'

# 6. ë§¤í•‘ íŒŒì¼ì—ì„œ ë²•ì •ë™ëª…ì´ ìˆëŠ” ì»¬ëŸ¼ ì´ë¦„
MAP_ADDRESS_COLUMN = 'ë²•ì •ë™ëª…'

# ------------------------------------------------------------------------------
pnu_to_address_converter_v2(
    input_file_name=INPUT_FILE,
    map_file_name=MAP_FILE,
    output_file_name=OUTPUT_FILE,
    pnu_column_name=PNU_COLUMN,
    map_pnu_column=MAP_PNU_COLUMN,
    map_address_column=MAP_ADDRESS_COLUMN
)
