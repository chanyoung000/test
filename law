"""
land_rules_crawler.py
- 162ê°œ ì§€ìì²´ ê±´íìœ¨/ìš©ì ë¥  ìë™ ìˆ˜ì§‘
- ìì¹˜ë²•ê·œì •ë³´ì‹œìŠ¤í…œ API í™œìš©
"""

import requests
import pandas as pd
import re
from datetime import datetime
import time

class LandRulesCrawler:
    def __init__(self, api_key=None):
        """
        api_key: ìì¹˜ë²•ê·œì •ë³´ì‹œìŠ¤í…œ API í‚¤ (ì„ íƒ)
                 ì—†ìœ¼ë©´ ì›¹ í¬ë¡¤ë§ ëª¨ë“œ
        """
        self.api_key = api_key
        self.results = []
        
        # 162ê°œ ì§€ìì²´ ë¦¬ìŠ¤íŠ¸
        self.regions = self._load_regions()
        
        # 21ê°œ ìš©ë„ì§€ì—­ í‘œì¤€
        self.zone_types = [
            'ì œ1ì¢…ì „ìš©ì£¼ê±°ì§€ì—­', 'ì œ2ì¢…ì „ìš©ì£¼ê±°ì§€ì—­',
            'ì œ1ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­', 'ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­', 'ì œ3ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­',
            'ì¤€ì£¼ê±°ì§€ì—­',
            'ì¤‘ì‹¬ìƒì—…ì§€ì—­', 'ì¼ë°˜ìƒì—…ì§€ì—­', 'ê·¼ë¦°ìƒì—…ì§€ì—­', 'ìœ í†µìƒì—…ì§€ì—­',
            'ì „ìš©ê³µì—…ì§€ì—­', 'ì¼ë°˜ê³µì—…ì§€ì—­', 'ì¤€ê³µì—…ì§€ì—­',
            'ë³´ì „ë…¹ì§€ì§€ì—­', 'ìƒì‚°ë…¹ì§€ì§€ì—­', 'ìì—°ë…¹ì§€ì§€ì—­',
            'ë³´ì „ê´€ë¦¬ì§€ì—­', 'ìƒì‚°ê´€ë¦¬ì§€ì—­', 'ê³„íšê´€ë¦¬ì§€ì—­',
            'ë†ë¦¼ì§€ì—­', 'ìì—°í™˜ê²½ë³´ì „ì§€ì—­'
        ]
    
    def _load_regions(self):
        """162ê°œ ì§€ìì²´ ë¦¬ìŠ¤íŠ¸"""
        return [
            "ì„œìš¸íŠ¹ë³„ì‹œ", "ë¶€ì‚°ê´‘ì—­ì‹œ", "ëŒ€êµ¬ê´‘ì—­ì‹œ", "ì¸ì²œê´‘ì—­ì‹œ",
            "ê´‘ì£¼ê´‘ì—­ì‹œ", "ëŒ€ì „ê´‘ì—­ì‹œ", "ìš¸ì‚°ê´‘ì—­ì‹œ", "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ",
            "ê²½ê¸°ë„ ê³ ì–‘ì‹œ", "ê²½ê¸°ë„ ê³¼ì²œì‹œ", "ê²½ê¸°ë„ ê´‘ëª…ì‹œ", "ê²½ê¸°ë„ ê´‘ì£¼ì‹œ",
            # ... (ì „ì²´ 162ê°œ)
        ]
    
    def get_ordinance_from_api(self, region_name):
        """
        APIë¡œ ì¡°ë¡€ ê°€ì ¸ì˜¤ê¸°
        """
        if not self.api_key:
            print("âš ï¸ API í‚¤ ì—†ìŒ. ì›¹ í¬ë¡¤ë§ ëª¨ë“œë¡œ ì „í™˜")
            return self.get_ordinance_from_web(region_name)
        
        url = "https://www.elis.go.kr/openapi/ordinanceInfo.do"
        params = {
            'serviceKey': self.api_key,
            'query': f'{region_name} ë„ì‹œê³„íš ì¡°ë¡€',
            'type': 'json'
        }
        
        try:
            response = requests.get(url, params=params, timeout=10)
            data = response.json()
            return data
        except Exception as e:
            print(f"âŒ API ì˜¤ë¥˜: {e}")
            return None
    
    def get_ordinance_from_web(self, region_name):
        """
        ì›¹ í¬ë¡¤ë§ìœ¼ë¡œ ì¡°ë¡€ ê°€ì ¸ì˜¤ê¸° (API ì—†ì„ ë•Œ)
        """
        # êµ­ê°€ë²•ë ¹ì •ë³´ì„¼í„°ì—ì„œ ê²€ìƒ‰
        url = "https://www.law.go.kr/LSW/ordinInfoP.do"
        params = {
            'ordinSeq': '',  # ì¡°ë¡€ ì¼ë ¨ë²ˆí˜¸
            'searchType': 'name',
            'query': f'{region_name} ë„ì‹œê³„íš'
        }
        
        try:
            response = requests.get(url, params=params, timeout=10)
            # HTML íŒŒì‹± í•„ìš”
            return response.text
        except Exception as e:
            print(f"âŒ ì›¹ í¬ë¡¤ë§ ì˜¤ë¥˜: {e}")
            return None
    
    def parse_ordinance(self, ordinance_data, region_name):
        """
        ì¡°ë¡€ì—ì„œ ê±´íìœ¨/ìš©ì ë¥  ì¶”ì¶œ
        """
        # ì¡°ë¡€ í…ìŠ¤íŠ¸ ì¶”ì¶œ
        if isinstance(ordinance_data, dict):
            text = ordinance_data.get('content', '')
        else:
            text = str(ordinance_data)
        
        # ê±´íìœ¨ ì¡°í•­ ì°¾ê¸°
        coverage_pattern = r'ê±´íìœ¨.*?ì œ(\d+)ì¡°'
        coverage_match = re.search(coverage_pattern, text)
        coverage_article = f"ì œ{coverage_match.group(1)}ì¡°" if coverage_match else "ì œ55ì¡°"
        
        # ìš©ì ë¥  ì¡°í•­ ì°¾ê¸°
        ratio_pattern = r'ìš©ì ë¥ .*?ì œ(\d+)ì¡°'
        ratio_match = re.search(ratio_pattern, text)
        ratio_article = f"ì œ{ratio_match.group(1)}ì¡°" if ratio_match else "ì œ56ì¡°"
        
        # ì‹œí–‰ì¼ ì°¾ê¸°
        date_pattern = r'ì‹œí–‰\s*(\d{4})\.(\d{1,2})\.(\d{1,2})'
        date_match = re.search(date_pattern, text)
        if date_match:
            ì‹œí–‰ì¼ = f"{date_match.group(1)}-{date_match.group(2):0>2}-{date_match.group(3):0>2}"
        else:
            ì‹œí–‰ì¼ = datetime.now().strftime('%Y-%m-%d')
        
        # ì¡°ë¡€ëª…
        ì¡°ë¡€ëª… = f"{region_name.split()[-1] if ' ' in region_name else region_name} ë„ì‹œê³„íš ì¡°ë¡€"
        if "íŠ¹ë³„ì‹œ" in region_name or "ê´‘ì—­ì‹œ" in region_name:
            ì¡°ë¡€ëª… = f"{region_name} ë„ì‹œê³„íš ì¡°ë¡€"
        
        # ê° ìš©ë„ì§€ì—­ë³„ ë°ì´í„° ìƒì„±
        for zone in self.zone_types:
            # ê¸°ë³¸ê°’ (êµ­í† ê³„íšë²• ê¸°ì¤€)
            default_values = self._get_default_values(zone)
            
            # ì¡°ë¡€ì—ì„œ íŠ¹ë³„ ê·œì • ì°¾ê¸°
            zone_pattern = rf'{zone}.*?(\d+).*?(\d+)'
            zone_match = re.search(zone_pattern, text)
            
            if zone_match:
                ê±´íìœ¨ = int(zone_match.group(1))
                ìš©ì ë¥  = int(zone_match.group(2))
            else:
                ê±´íìœ¨ = default_values['ê±´íìœ¨']
                ìš©ì ë¥  = default_values['ìš©ì ë¥ ']
            
            # ë¹„ê³  (ì—­ì„¸ê¶Œ ë“± íŠ¹ì´ì‚¬í•­)
            ë¹„ê³  = self._extract_remarks(text, zone)
            
            self.results.append({
                'ì§€ìì²´': region_name,
                'ìš©ë„ì§€ì—­': zone,
                'ê±´íìœ¨': ê±´íìœ¨,
                'ìš©ì ë¥ ': ìš©ì ë¥ ,
                'ì¡°ë¡€ëª…': ì¡°ë¡€ëª…,
                'ì¡°í•­': f"{coverage_article}Â·{ratio_article}",
                'ì‹œí–‰ì¼': ì‹œí–‰ì¼,
                'ë¹„ê³ ': ë¹„ê³ 
            })
    
    def _get_default_values(self, zone_type):
        """
        êµ­í† ê³„íšë²• ê¸°ë³¸ê°’
        """
        defaults = {
            'ì œ1ì¢…ì „ìš©ì£¼ê±°ì§€ì—­': {'ê±´íìœ¨': 50, 'ìš©ì ë¥ ': 100},
            'ì œ2ì¢…ì „ìš©ì£¼ê±°ì§€ì—­': {'ê±´íìœ¨': 50, 'ìš©ì ë¥ ': 150},
            'ì œ1ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­': {'ê±´íìœ¨': 60, 'ìš©ì ë¥ ': 200},
            'ì œ2ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­': {'ê±´íìœ¨': 60, 'ìš©ì ë¥ ': 250},
            'ì œ3ì¢…ì¼ë°˜ì£¼ê±°ì§€ì—­': {'ê±´íìœ¨': 50, 'ìš©ì ë¥ ': 300},
            'ì¤€ì£¼ê±°ì§€ì—­': {'ê±´íìœ¨': 70, 'ìš©ì ë¥ ': 500},
            'ì¤‘ì‹¬ìƒì—…ì§€ì—­': {'ê±´íìœ¨': 90, 'ìš©ì ë¥ ': 1500},
            'ì¼ë°˜ìƒì—…ì§€ì—­': {'ê±´íìœ¨': 80, 'ìš©ì ë¥ ': 1300},
            'ê·¼ë¦°ìƒì—…ì§€ì—­': {'ê±´íìœ¨': 70, 'ìš©ì ë¥ ': 900},
            'ìœ í†µìƒì—…ì§€ì—­': {'ê±´íìœ¨': 80, 'ìš©ì ë¥ ': 1100},
            'ì „ìš©ê³µì—…ì§€ì—­': {'ê±´íìœ¨': 70, 'ìš©ì ë¥ ': 300},
            'ì¼ë°˜ê³µì—…ì§€ì—­': {'ê±´íìœ¨': 70, 'ìš©ì ë¥ ': 350},
            'ì¤€ê³µì—…ì§€ì—­': {'ê±´íìœ¨': 70, 'ìš©ì ë¥ ': 400},
            'ë³´ì „ë…¹ì§€ì§€ì—­': {'ê±´íìœ¨': 20, 'ìš©ì ë¥ ': 80},
            'ìƒì‚°ë…¹ì§€ì§€ì—­': {'ê±´íìœ¨': 20, 'ìš©ì ë¥ ': 100},
            'ìì—°ë…¹ì§€ì§€ì—­': {'ê±´íìœ¨': 20, 'ìš©ì ë¥ ': 100},
            'ë³´ì „ê´€ë¦¬ì§€ì—­': {'ê±´íìœ¨': 20, 'ìš©ì ë¥ ': 80},
            'ìƒì‚°ê´€ë¦¬ì§€ì—­': {'ê±´íìœ¨': 20, 'ìš©ì ë¥ ': 80},
            'ê³„íšê´€ë¦¬ì§€ì—­': {'ê±´íìœ¨': 40, 'ìš©ì ë¥ ': 100},
            'ë†ë¦¼ì§€ì—­': {'ê±´íìœ¨': 20, 'ìš©ì ë¥ ': 80},
            'ìì—°í™˜ê²½ë³´ì „ì§€ì—­': {'ê±´íìœ¨': 20, 'ìš©ì ë¥ ': 80},
        }
        return defaults.get(zone_type, {'ê±´íìœ¨': 60, 'ìš©ì ë¥ ': 200})
    
    def _extract_remarks(self, text, zone_type):
        """
        ë¹„ê³  ì¶”ì¶œ (ì—­ì„¸ê¶Œ ë“±)
        """
        remarks = []
        
        # ì—­ì„¸ê¶Œ ì™„í™”
        station_pattern = rf'{zone_type}.*?ì—­ì„¸ê¶Œ.*?(\d+)%'
        station_match = re.search(station_pattern, text)
        if station_match:
            remarks.append(f"ì—­ì„¸ê¶Œ(ì§€í•˜ì² ì—­ 250m ì´ë‚´)ì€ {station_match.group(1)}%ê¹Œì§€ ì™„í™” ê°€ëŠ¥")
        
        # ì§€êµ¬ë‹¨ìœ„ê³„íš
        district_pattern = rf'{zone_type}.*?ì§€êµ¬ë‹¨ìœ„.*?(\d+)%'
        district_match = re.search(district_pattern, text)
        if district_match:
            remarks.append(f"ì§€êµ¬ë‹¨ìœ„ê³„íšêµ¬ì—­ ë‚´ {district_match.group(1)}%ê¹Œì§€ ì™„í™” ê°€ëŠ¥")
        
        return ', '.join(remarks) if remarks else ''
    
    def crawl_all(self):
        """
        ì „ì²´ ì§€ìì²´ í¬ë¡¤ë§
        """
        total = len(self.regions)
        
        for idx, region in enumerate(self.regions, 1):
            print(f"\n[{idx}/{total}] {region} ì²˜ë¦¬ ì¤‘...")
            
            try:
                # ì¡°ë¡€ ê°€ì ¸ì˜¤ê¸°
                ordinance = self.get_ordinance_from_api(region)
                
                if ordinance:
                    # íŒŒì‹±
                    self.parse_ordinance(ordinance, region)
                    print(f"âœ… {region} ì™„ë£Œ")
                else:
                    print(f"âš ï¸ {region} ì¡°ë¡€ ì—†ìŒ - ê¸°ë³¸ê°’ ì‚¬ìš©")
                    self._use_default_values(region)
                
                # ì„œë²„ ë¶€ë‹´ ì¤„ì´ê¸°
                time.sleep(1)
                
            except Exception as e:
                print(f"âŒ {region} ì˜¤ë¥˜: {e}")
                self._use_default_values(region)
        
        print(f"\n{'='*60}")
        print(f"ğŸ‰ ì „ì²´ ì‘ì—… ì™„ë£Œ!")
        print(f"ì´ {len(self.results)}ê°œ ë°ì´í„° ìˆ˜ì§‘")
        print(f"{'='*60}\n")
    
    def _use_default_values(self, region_name):
        """
        ì¡°ë¡€ ì—†ì„ ë•Œ ê¸°ë³¸ê°’ ì‚¬ìš©
        """
        for zone in self.zone_types:
            default = self._get_default_values(zone)
            self.results.append({
                'ì§€ìì²´': region_name,
                'ìš©ë„ì§€ì—­': zone,
                'ê±´íìœ¨': default['ê±´íìœ¨'],
                'ìš©ì ë¥ ': default['ìš©ì ë¥ '],
                'ì¡°ë¡€ëª…': f"{region_name} ë„ì‹œê³„íš ì¡°ë¡€",
                'ì¡°í•­': 'êµ­í† ê³„íšë²• ê¸°ì¤€',
                'ì‹œí–‰ì¼': datetime.now().strftime('%Y-%m-%d'),
                'ë¹„ê³ ': 'ì¡°ë¡€ ë¯¸í™•ì¸ - êµ­í† ê³„íšë²• ê¸°ë³¸ê°’'
            })
    
    def save_to_csv(self, filename='land_rules_korea_162.csv'):
        """
        CSV ì €ì¥
        """
        df = pd.DataFrame(self.results)
        
        # ì»¬ëŸ¼ ìˆœì„œ
        columns = ['ì§€ìì²´', 'ìš©ë„ì§€ì—­', 'ê±´íìœ¨', 'ìš©ì ë¥ ', 
                   'ì¡°ë¡€ëª…', 'ì¡°í•­', 'ì‹œí–‰ì¼', 'ë¹„ê³ ']
        df = df[columns]
        
        # ì €ì¥
        df.to_csv(filename, index=False, encoding='utf-8-sig')
        
        print(f"âœ… CSV ì €ì¥ ì™„ë£Œ: {filename}")
        print(f"ğŸ“Š ì´ {len(df)}ê°œ ë°ì´í„°")
        
        return df
    
    def save_to_sqlite(self, db_name='land_rules.db'):
        """
        SQLite DB ì €ì¥
        """
        import sqlite3
        
        df = pd.DataFrame(self.results)
        conn = sqlite3.connect(db_name)
        df.to_sql('land_rules', conn, if_exists='replace', index=False)
        conn.close()
        
        print(f"âœ… DB ì €ì¥ ì™„ë£Œ: {db_name}")

# ì‹¤í–‰
if __name__ == "__main__":
    print("="*60)
    print("ğŸ—ï¸  ëŒ€í•œë¯¼êµ­ 162ê°œ ì§€ìì²´ ê±´íìœ¨/ìš©ì ë¥  ìˆ˜ì§‘ê¸°")
    print("="*60)
    
    # API í‚¤ (ì„ íƒ)
    API_KEY = None  # ë˜ëŠ” ë°œê¸‰ë°›ì€ í‚¤ ì…ë ¥
    
    # í¬ë¡¤ëŸ¬ ìƒì„±
    crawler = LandRulesCrawler(api_key=API_KEY)
    
    # ì „ì²´ ìˆ˜ì§‘
    crawler.crawl_all()
    
    # CSV ì €ì¥
    df = crawler.save_to_csv()
    
    # DB ì €ì¥
    crawler.save_to_sqlite()
    
    # ë¯¸ë¦¬ë³´ê¸°
    print("\n=== ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° ===")
    print(df.head(10))
    
    print("\n=== í†µê³„ ===")
    print(f"ì§€ìì²´ ìˆ˜: {df['ì§€ìì²´'].nunique()}ê°œ")
    print(f"ìš©ë„ì§€ì—­ ìˆ˜: {df['ìš©ë„ì§€ì—­'].nunique()}ê°œ")
    print(f"ì´ ë°ì´í„°: {len(df)}ê°œ")
