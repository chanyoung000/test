import pandas as pd
import re
import requests
import folium
import tkinter as tk
from tkinter import messagebox, ttk, filedialog, colorchooser, simpledialog
import json
import webbrowser
import os
import sys
import geopandas as gpd
from shapely.geometry import shape
import openpyxl
import urllib3
import concurrent.futures
import threading
import time
from concurrent.futures import ThreadPoolExecutor
import xmltodict

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)


# [ê¸°ëŠ¥ 1] ë””ë²„ê¹… ë¡œê·¸ ì¶œë ¥ í•¨ìˆ˜
def debug_log(msg):
    print(f"[DEBUG] {msg}")


# ====== 1. ì„¤ì • ë° API í‚¤ ======
if getattr(sys, 'frozen', False):
    base_dir = os.path.dirname(sys.executable)
else:
    base_dir = os.path.dirname(os.path.abspath(__file__))

# VWorld API í‚¤
key_path = os.path.join(base_dir, 'vworld_key.txt')
try:
    with open(key_path, 'r') as f:
        vworld_key = f.read().strip()
    debug_log(f"VWorld í‚¤ ë¡œë“œ ì„±ê³µ: {vworld_key[:5]}...")
except FileNotFoundError:
    vworld_key = "API_KEY_NOT_FOUND"
    debug_log("VWorld í‚¤ íŒŒì¼ ì—†ìŒ")

# ê³µê³µë°ì´í„°í¬í„¸ API í‚¤ (ê±´ì¶•ë¬¼ëŒ€ì¥)
BUILDING_SERVICE_KEY = "dA0iXwhwNG8gqMCqQkgBeLpp62nNTj2lUTwu4oL0I62spbFID+HCuVbpjvMgjwA8DZqq+nzZEx8WWlwhBTfB8w=="

BUILDING_API_URL = "http://apis.data.go.kr/1613000/BldRgstHubService/getBrTitleInfo"
BUILDING_RECAP_API_URL = "http://apis.data.go.kr/1613000/BldRgstHubService/getBrRecapTitleInfo"

# ====== 1-2. ì»¤ìŠ¤í…€ DB ë¡œë“œ (DB.csv) ======
# êµ¬ì¡°: { 'ì‹œêµ°êµ¬ì½”ë“œ': { 'ìš©ë„ì§€ì—­ëª…': {'bc':ê°’, 'vl':ê°’, 'code':UCode} } }
CUSTOM_LIMIT_DB = {}


def load_custom_db():
    global CUSTOM_LIMIT_DB
    db_path = os.path.join(base_dir, "DB.csv")

    if not os.path.exists(db_path):
        debug_log("âš ï¸ DB.csv íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. í•œê³„ê°’ ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.")
        return

    try:
        try:
            df = pd.read_csv(db_path, encoding='utf-8-sig')
        except UnicodeDecodeError:
            df = pd.read_csv(db_path, encoding='cp949')

        df.columns = [c.strip() for c in df.columns]

        # í•„ìˆ˜ ì»¬ëŸ¼ í™•ì¸
        required = ['ì‹œêµ°êµ¬ì½”ë“œ', 'ìš©ë„ì§€ì—­', 'ê±´íìœ¨', 'ìš©ì ë¥ ']
        for r in required:
            if r not in df.columns:
                debug_log(f"âš ï¸ DB.csvì— '{r}' ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤.")
                return

        count = 0
        for _, row in df.iterrows():
            code = str(row['ì‹œêµ°êµ¬ì½”ë“œ']).strip().split('.')[0]
            zone = str(row['ìš©ë„ì§€ì—­']).strip()
            bc = str(row['ê±´íìœ¨']).strip()
            vl = str(row['ìš©ì ë¥ ']).strip()

            if code not in CUSTOM_LIMIT_DB:
                CUSTOM_LIMIT_DB[code] = {}

            CUSTOM_LIMIT_DB[code][zone] = {'bc': bc, 'vl': vl}
            count += 1

        debug_log(f"âœ… DB.csv ë¡œë“œ ì™„ë£Œ ({len(CUSTOM_LIMIT_DB)}ê°œ ì§€ìì²´, {count}ê°œ ë°ì´í„°)")

    except Exception as e:
        debug_log(f"âŒ DB.csv ë¡œë“œ ì¤‘ ì˜¤ë¥˜: {e}")


load_custom_db()

# ====== 2. í–‰ì •êµ¬ì—­ ë°ì´í„° ======
# (ì°¸ê³ ) ì‹¤ì œ ì‚¬ìš©ì‹œì—ëŠ” CSVì—ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” ê²ƒì´ ë” ì¢‹ì§€ë§Œ, í˜„ì¬ëŠ” ê¸°ì¡´ ë”•ì…”ë„ˆë¦¬ ìœ ì§€
sigungu_dict = {
    "ì„œìš¸íŠ¹ë³„ì‹œ": ["ì¢…ë¡œêµ¬", "ì¤‘êµ¬", "ìš©ì‚°êµ¬", "ì„±ë™êµ¬", "ê´‘ì§„êµ¬", "ë™ëŒ€ë¬¸êµ¬", "ì¤‘ë‘êµ¬", "ì„±ë¶êµ¬", "ê°•ë¶êµ¬", "ë„ë´‰êµ¬", "ë…¸ì›êµ¬", "ì€í‰êµ¬", "ì„œëŒ€ë¬¸êµ¬", "ë§ˆí¬êµ¬", "ì–‘ì²œêµ¬",
              "ê°•ì„œêµ¬", "êµ¬ë¡œêµ¬", "ê¸ˆì²œêµ¬", "ì˜ë“±í¬êµ¬", "ë™ì‘êµ¬", "ê´€ì•…êµ¬", "ì„œì´ˆêµ¬", "ê°•ë‚¨êµ¬", "ì†¡íŒŒêµ¬", "ê°•ë™êµ¬"],
    "ê²½ê¸°ë„": ["ì„±ë‚¨ì‹œ ìˆ˜ì •êµ¬", "ì„±ë‚¨ì‹œ ì¤‘ì›êµ¬", "ì„±ë‚¨ì‹œ ë¶„ë‹¹êµ¬", "ì˜ì •ë¶€ì‹œ", "ì•ˆì–‘ì‹œ ë§Œì•ˆêµ¬", "í•˜ë‚¨ì‹œ", "ìš©ì¸ì‹œ ì²˜ì¸êµ¬", "ìš©ì¸ì‹œ ê¸°í¥êµ¬", "ìš©ì¸ì‹œ ìˆ˜ì§€êµ¬", "íŒŒì£¼ì‹œ",
            "ìˆ˜ì›ì‹œ ì¥ì•ˆêµ¬", "ìˆ˜ì›ì‹œ ê¶Œì„ êµ¬", "ìˆ˜ì›ì‹œ íŒ”ë‹¬êµ¬", "ìˆ˜ì›ì‹œ ì˜í†µêµ¬", "ì•ˆì–‘ì‹œ ë™ì•ˆêµ¬", "ë¶€ì²œì‹œ", "ê´‘ëª…ì‹œ", "í‰íƒì‹œ", "ë™ë‘ì²œì‹œ", "ì•ˆì‚°ì‹œ ìƒë¡êµ¬", "ì•ˆì‚°ì‹œ ë‹¨ì›êµ¬",
            "ê³ ì–‘ì‹œ ë•ì–‘êµ¬", "ê³ ì–‘ì‹œ ì¼ì‚°ë™êµ¬", "ê³ ì–‘ì‹œ ì¼ì‚°ì„œêµ¬", "ê³¼ì²œì‹œ", "êµ¬ë¦¬ì‹œ", "ë‚¨ì–‘ì£¼ì‹œ", "ì˜¤ì‚°ì‹œ", "ì‹œí¥ì‹œ", "êµ°í¬ì‹œ", "ì˜ì™•ì‹œ", "ì´ì²œì‹œ", "ì•ˆì„±ì‹œ", "ê¹€í¬ì‹œ",
            "í™”ì„±ì‹œ", "ê´‘ì£¼ì‹œ", "ì—¬ì£¼ì‹œ", "ì–‘í‰êµ°", "ì—°ì²œêµ°", "í¬ì²œì‹œ", "ê°€í‰êµ°"],
    "ë¶€ì‚°ê´‘ì—­ì‹œ": ["ì¤‘êµ¬", "ì„œêµ¬", "ë™êµ¬", "ì˜ë„êµ¬", "ë¶€ì‚°ì§„êµ¬", "ë™ë˜êµ¬", "ë‚¨êµ¬", "ë¶êµ¬", "í•´ìš´ëŒ€êµ¬", "ì‚¬í•˜êµ¬", "ê¸ˆì •êµ¬", "ê°•ì„œêµ¬", "ì—°ì œêµ¬", "ìˆ˜ì˜êµ¬", "ì‚¬ìƒêµ¬",
              "ê¸°ì¥êµ°"],
    "ëŒ€êµ¬ê´‘ì—­ì‹œ": ["ì¤‘êµ¬", "ë™êµ¬", "ì„œêµ¬", "ë‚¨êµ¬", "ë¶êµ¬", "ìˆ˜ì„±êµ¬", "ë‹¬ì„œêµ¬", "ë‹¬ì„±êµ°", "êµ°ìœ„êµ°"],
    "ì¸ì²œê´‘ì—­ì‹œ": ["ì¤‘êµ¬", "ë™êµ¬", "ë¯¸ì¶”í™€êµ¬", "ì—°ìˆ˜êµ¬", "ë‚¨ë™êµ¬", "ë¶€í‰êµ¬", "ê³„ì–‘êµ¬", "ì„œêµ¬", "ê°•í™”êµ°", "ì˜¹ì§„êµ°"],
    "ê´‘ì£¼ê´‘ì—­ì‹œ": ["ë™êµ¬", "ì„œêµ¬", "ë‚¨êµ¬", "ë¶êµ¬", "ê´‘ì‚°êµ¬"],
    "ëŒ€ì „ê´‘ì—­ì‹œ": ["ë™êµ¬", "ì¤‘êµ¬", "ì„œêµ¬", "ìœ ì„±êµ¬", "ëŒ€ë•êµ¬"],
    "ìš¸ì‚°ê´‘ì—­ì‹œ": ["ì¤‘êµ¬", "ë‚¨êµ¬", "ë™êµ¬", "ë¶êµ¬", "ìš¸ì£¼êµ°"],
    "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ": ["ì„¸ì¢…ì‹œ"],
    "ê°•ì›íŠ¹ë³„ìì¹˜ë„": ["ì¶˜ì²œì‹œ", "ì›ì£¼ì‹œ", "ê°•ë¦‰ì‹œ", "ë™í•´ì‹œ", "íƒœë°±ì‹œ", "ì†ì´ˆì‹œ", "ì‚¼ì²™ì‹œ", "í™ì²œêµ°", "íš¡ì„±êµ°", "ì˜ì›”êµ°", "í‰ì°½êµ°", "ì •ì„ êµ°", "ì² ì›êµ°", "í™”ì²œêµ°", "ì–‘êµ¬êµ°",
                "ì¸ì œêµ°", "ê³ ì„±êµ°", "ì–‘ì–‘êµ°"],
    "ì¶©ì²­ë¶ë„": ["ì²­ì£¼ì‹œ ìƒë‹¹êµ¬", "ì²­ì£¼ì‹œ ì„œì›êµ¬", "ì²­ì£¼ì‹œ í¥ë•êµ¬", "ì²­ì£¼ì‹œ ì²­ì›êµ¬", "ì¶©ì£¼ì‹œ", "ì œì²œì‹œ", "ë³´ì€êµ°", "ì˜¥ì²œêµ°", "ì˜ë™êµ°", "ì¦í‰êµ°", "ì§„ì²œêµ°", "ê´´ì‚°êµ°", "ìŒì„±êµ°",
             "ë‹¨ì–‘êµ°"],
    "ì¶©ì²­ë‚¨ë„": ["ì²œì•ˆì‹œ ë™ë‚¨êµ¬", "ì²œì•ˆì‹œ ì„œë¶êµ¬", "ê³µì£¼ì‹œ", "ë³´ë ¹ì‹œ", "ì•„ì‚°ì‹œ", "ì„œì‚°ì‹œ", "ë…¼ì‚°ì‹œ", "ê³„ë£¡ì‹œ", "ë‹¹ì§„ì‹œ", "ê¸ˆì‚°êµ°", "ë¶€ì—¬êµ°", "ì„œì²œêµ°", "ì²­ì–‘êµ°", "í™ì„±êµ°",
             "ì˜ˆì‚°êµ°", "íƒœì•ˆêµ°"],
    "ì „ë¶íŠ¹ë³„ìì¹˜ë„": ["ì „ì£¼ì‹œ ì™„ì‚°êµ¬", "ì „ì£¼ì‹œ ë•ì§„êµ¬", "êµ°ì‚°ì‹œ", "ìµì‚°ì‹œ", "ì •ìì‹œ", "ë‚¨ì›ì‹œ", "ê¹€ì œì‹œ", "ì™„ì£¼êµ°", "ì§„ì•ˆêµ°", "ë¬´ì£¼êµ°", "ì¥ìˆ˜êµ°", "ì„ì‹¤êµ°", "ìˆœì°½êµ°",
                "ê³ ì°½êµ°", "ë¶€ì•ˆêµ°"],
    "ì „ë¼ë‚¨ë„": ["ëª©í¬ì‹œ", "ì—¬ìˆ˜ì‹œ", "ìˆœì²œì‹œ", "ë‚˜ì£¼ì‹œ", "ê´‘ì–‘ì‹œ", "ë‹´ì–‘êµ°", "ê³¡ì„±êµ°", "êµ¬ë¡€êµ°", "ê³ í¥êµ°", "ë³´ì„±êµ°", "í™”ìˆœêµ°", "ì¥í¥êµ°", "ê°•ì§„êµ°", "í•´ë‚¨êµ°", "ì˜ì•”êµ°",
             "ë¬´ì•ˆêµ°", "í•¨í‰êµ°", "ì˜ê´‘êµ°", "ì¥ì„±êµ°", "ì™„ë„êµ°", "ì§„ë„êµ°", "ì‹ ì•ˆêµ°"],
    "ê²½ìƒë¶ë„": ["í¬í•­ì‹œ ë‚¨êµ¬", "í¬í•­ì‹œ ë¶êµ¬", "ê²½ì£¼ì‹œ", "ê¹€ì²œì‹œ", "ì•ˆë™ì‹œ", "êµ¬ë¯¸ì‹œ", "ì˜ì£¼ì‹œ", "ì˜ì²œì‹œ", "ìƒì£¼ì‹œ", "ë¬¸ê²½ì‹œ", "ê²½ì‚°ì‹œ", "êµ°ìœ„êµ°", "ì˜ì„±êµ°", "ì²­ì†¡êµ°",
             "ì˜ì–‘êµ°", "ì˜ë•êµ°", "ì²­ë„êµ°", "ê³ ë ¹êµ°", "ì„±ì£¼êµ°", "ì¹ ê³¡êµ°", "ì˜ˆì²œêµ°", "ë´‰í™”êµ°", "ìš¸ì§„êµ°", "ìš¸ë¦‰êµ°"],
    "ê²½ìƒë‚¨ë„": ["ì°½ì›ì‹œ ì˜ì°½êµ¬", "ì°½ì›ì‹œ ì„±ì‚°êµ¬", "ì°½ì›ì‹œ ë§ˆì‚°í•©í¬êµ¬", "ì°½ì›ì‹œ ë§ˆì‚°íšŒì›êµ¬", "ì°½ì›ì‹œ ì§„í•´êµ¬", "ì§„ì£¼ì‹œ", "í†µì˜ì‹œ", "ì‚¬ì²œì‹œ", "ê¹€í•´ì‹œ", "ë°€ì–‘ì‹œ", "ê±°ì œì‹œ", "ì–‘ì‚°ì‹œ",
             "ì˜ë ¹êµ°", "í•¨ì•ˆêµ°", "ì°½ë…•êµ°", "ê³ ì„±êµ°", "ë‚¨í•´êµ°", "í•˜ë™êµ°", "ì‚°ì²­êµ°", "í•¨ì–‘êµ°", "ê±°ì°½êµ°", "í•©ì²œêµ°"],
    "ì œì£¼íŠ¹ë³„ìì¹˜ë„": ["ì œì£¼ì‹œ", "ì„œê·€í¬ì‹œ"]
}
sido_list = list(sigungu_dict.keys())

# ====== 3. ë²•ì •ë™ì½”ë“œ ë¶ˆëŸ¬ì˜¤ê¸° ======
csv_path = os.path.join(base_dir, 'êµ­í† êµí†µë¶€_ë²•ì •ë™ì½”ë“œ_20240805.csv')
dong_lookup = {}

if os.path.exists(csv_path):
    try:
        dong_df = pd.read_csv(csv_path, encoding="cp949")
        dong_df = dong_df[dong_df["íì§€ì—¬ë¶€"] == "ì¡´ì¬"]
        for _, row in dong_df.iterrows():
            name = row['ë²•ì •ë™ëª…']
            code = str(row['ë²•ì •ë™ì½”ë“œ'])
            parts = name.split()
            if not parts: continue
            dong_name = parts[-1]
            sido = parts[0]
            sigungu = " ".join(parts[1:-1])
            if dong_name not in dong_lookup:
                dong_lookup[dong_name] = []
            dong_lookup[dong_name].append({'full_addr': name, 'sido': sido, 'sigungu': sigungu, 'code': code})
        debug_log(f"ë²•ì •ë™ CSV ë¡œë“œ ì™„ë£Œ ({len(dong_lookup)}ê°œ ë™)")
    except Exception as e:
        debug_log(f"ë²•ì •ë™ ë¡œë“œ ì‹¤íŒ¨: {e}")
        dong_lookup = {}
else:
    debug_log("ë²•ì •ë™ CSV íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
    dong_lookup = {}

excel_features = []
data_lock = threading.Lock()


# ====== 4. í•µì‹¬ ê¸°ëŠ¥ í•¨ìˆ˜ë“¤ ======

def to_pyeong_str(val, decimals=2):
    try:
        if not val: return ""
        pyeong = float(val) * 0.3025
        if decimals == 0:
            return f"{pyeong:,.0f}"
        return f"{pyeong:.{decimals}f}"
    except:
        return ""


def save_to_excel():
    global excel_features
    if not excel_features:
        messagebox.showerror("ì˜¤ë¥˜", "ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
        return

    result_dir = os.path.join(base_dir, "result")
    if not os.path.exists(result_dir):
        os.makedirs(result_dir)

    filename = simpledialog.askstring("ì—‘ì…€ ì €ì¥", "ì €ì¥í•  íŒŒì¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš” (í™•ì¥ì ì œì™¸):")
    if not filename:
        return

    save_path = os.path.join(result_dir, f"{filename}.xlsx")

    try:
        temp_list = []
        seen = set()

        for f in excel_features:
            p = f.get("properties", {})
            addr = p.get("addr", "")

            if addr:
                if addr not in seen:
                    seen.add(addr)

                arch_area_py = to_pyeong_str(p.get("ê±´ì¶•ë©´ì ", ""), 2)
                tot_area_py = to_pyeong_str(p.get("ì—°ë©´ì ", ""), 2)

                # ì§€êµ¬ë‹¨ìœ„ê³„íš ì—¬ë¶€ í™•ì¸ ë° ë¹„ê³  ì‘ì„±
                district_plan = p.get("ì§€êµ¬ë‹¨ìœ„ê³„íšêµ¬ì—­", "")
                remark = "ì§€êµ¬ë‹¨ìœ„ê³„íšêµ¬ì—­ìƒ ê±´íìœ¨/ìš©ì ë¥  í™•ì¸ í•„ìˆ˜!" if district_plan else ""

                temp_list.append([
                    p.get("addr", ""),
                    p.get("ì§€ëª©", ""),
                    p.get("ë©´ì ", ""),
                    p.get("ê³µì‹œì§€ê°€", ""),
                    p.get("ì†Œìœ êµ¬ë¶„", ""),
                    p.get("ê³µìœ ì¸ìˆ˜", ""),

                    # ìš©ë„ì§€ì—­ ë¶„ë¦¬
                    p.get("ìš©ë„ì§€ì—­1", ""),
                    p.get("ìš©ë„ì§€ì—­2", ""),
                    p.get("ìš©ë„ì§€ì—­3", ""),

                    # í•œê³„ vs í˜„ì¬ ë¹„êµ ë°°ì¹˜
                    p.get("í•œê³„ê±´íìœ¨", ""),
                    p.get("ê±´íìœ¨", ""),  # í˜„ì¬ê±´íìœ¨
                    p.get("í•œê³„ìš©ì ë¥ ", ""),
                    p.get("ìš©ì ë¥ ", ""),  # í˜„ì¬ìš©ì ë¥ 

                    # íŠ¹ì • êµ¬ì—­
                    district_plan,
                    p.get("êµ­ê°€ì‚°ì—…ë‹¨ì§€", ""),
                    p.get("ê°œë°œì œí•œêµ¬ì—­", ""),

                    p.get("ê±´ë¬¼ëª…", ""),
                    p.get("ì£¼ìš©ë„", ""),
                    arch_area_py,
                    tot_area_py,
                    p.get("ë†’ì´", ""),
                    p.get("ì§€ìƒì¸µìˆ˜", ""),
                    p.get("ì§€í•˜ì¸µìˆ˜", ""),
                    p.get("ì‚¬ìš©ìŠ¹ì¸ì¼", ""),

                    p.get("ê¸°íƒ€ìš©ë„ì§€ì—­", ""),
                    remark  # [ì¶”ê°€] ë¹„ê³ 
                ])

        wb = openpyxl.Workbook()
        ws = wb.active
        ws.title = "í†µí•©ì •ë³´"

        headers = [
            "ì£¼ì†Œ/PNU", "ì§€ëª©", "ë©´ì (í‰)", "ê³µì‹œì§€ê°€(í‰ë‹¹)", "ì†Œìœ êµ¬ë¶„", "ê³µìœ ì¸ìˆ˜",
            "ìš©ë„ì§€ì—­1", "ìš©ë„ì§€ì—­2", "ìš©ë„ì§€ì—­3",
            "í•œê³„ê±´íìœ¨", "í˜„ì¬ê±´íìœ¨(%)", "í•œê³„ìš©ì ë¥ ", "í˜„ì¬ìš©ì ë¥ (%)",
            "ì§€êµ¬ë‹¨ìœ„ê³„íš", "êµ­ê°€ì‚°ì—…ë‹¨ì§€", "ê°œë°œì œí•œêµ¬ì—­",
            "ê±´ë¬¼ëª…", "ì£¼ìš©ë„", "ê±´ì¶•ë©´ì (í‰)", "ì—°ë©´ì (í‰)", "ë†’ì´(m)", "ì§€ìƒì¸µ", "ì§€í•˜ì¸µ", "ì‚¬ìš©ìŠ¹ì¸ì¼",
            "ê¸°íƒ€ ê·œì œì‚¬í•­", "ë¹„ê³ (Check)"
        ]
        ws.append(headers)

        for row in temp_list:
            ws.append(row)

        wb.save(save_path)
        messagebox.showinfo("ì™„ë£Œ", f"ì €ì¥ ì™„ë£Œ!\nìœ„ì¹˜: {save_path}\nì´ {len(temp_list)}ê°œ ë°ì´í„°")

        try:
            os.startfile(save_path)
        except Exception:
            pass

    except Exception as e:
        messagebox.showerror("ì €ì¥ ì˜¤ë¥˜", str(e))


def address_to_pnu(address: str) -> str:
    address = address.strip()
    if re.match(r'^\d{19}$', address): return address

    is_san = bool(re.search(r'\bì‚°\s*\d+', address))

    match = re.search(r'(.+?(ë™|ì|ë©´|ë¦¬|ë¡œ\s?\d+ê°€|ê°€\s?\d+ê°€?))\s*(ì‚°)?\s*(\d+)-?(\d*)', address)
    if not match:
        debug_log(f"ì£¼ì†Œ í˜•ì‹ ë¶ˆì¼ì¹˜: {address}")
        raise ValueError("ì£¼ì†Œ í˜•ì‹ì„ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

    full_loc_part = match.group(1).strip()
    dong_name = full_loc_part.split()[-1].strip()

    if dong_name not in dong_lookup:
        split_parts = full_loc_part.split()
        fallback_dong = split_parts[-1]
        if fallback_dong in dong_lookup:
            dong_name = fallback_dong
        else:
            debug_log(f"ë²•ì •ë™ ë§¤ì¹­ ì‹¤íŒ¨: {dong_name} (ì…ë ¥ì£¼ì†Œ: {address})")
            raise ValueError(f"ë²•ì •ë™ '{dong_name}'ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

    candidates = dong_lookup[dong_name]
    selected_code = None

    if len(candidates) == 1:
        selected_code = candidates[0]['code']
    else:
        best_match = None
        max_score = 0
        for cand in candidates:
            score = 0
            if cand['sido'] in full_loc_part: score += 2
            if cand['sigungu'] in full_loc_part: score += 3
            for part in cand['sigungu'].split():
                if part in full_loc_part: score += 1

            if score > max_score:
                max_score = score
                best_match = cand

        if best_match and max_score > 0:
            selected_code = best_match['code']
        else:
            debug_log(f"ë²•ì •ë™ ì¤‘ë³µ ë§¤ì¹­ ì‹¤íŒ¨: {dong_name}")
            raise ValueError(f"'{dong_name}'ì€ ì—¬ëŸ¬ ë„ì‹œì— ì¡´ì¬í•˜ë©°, ì‹œêµ°êµ¬ë¥¼ íŠ¹ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

    main_number = match.group(4).zfill(4)
    sub_number = match.group(5).zfill(4) if match.group(5) else '0000'
    san_code = '2' if is_san else '1'

    pnu = f"{selected_code}{san_code}{main_number}{sub_number}"
    debug_log(f"PNU ë³€í™˜ ì„±ê³µ: {address} -> {pnu}")
    return pnu


# ====== [ë°ì´í„° ì¡°íšŒ í•¨ìˆ˜] ======
def get_geojson_by_pnu(pnu: str, stop_event):
    # 1. ê°œë³„ê³µì‹œì§€ê°€
    def get_official_price(pnu):
        if stop_event.is_set(): return ""
        try:
            url = "https://api.vworld.kr/ned/data/getIndvdLandPriceAttr"
            params = {"key": vworld_key, "pnu": pnu, "format": "json", "numOfRows": "10", "pageNo": "1",
                      "domain": "http://localhost"}
            res = requests.get(url, params=params, verify=False, timeout=5)
            if res.status_code == 200:
                data = res.json()
                items = data.get("indvdLandPrices", {}).get("field", [])
                if items:
                    items.sort(key=lambda x: int(x.get('stdrYear', 0)), reverse=True)
                    price = items[0].get('pblntfPclnd', '0')
                    try:
                        return f"{float(price) / 0.3025:,.0f}"
                    except:
                        return ""
        except:
            pass
        return ""

    # 2. í† ì§€ëŒ€ì¥
    def get_ladfrl_details(pnu):
        if stop_event.is_set(): return {}
        try:
            url = "https://api.vworld.kr/ned/data/ladfrlList"
            params = {"key": vworld_key, "domain": "land", "pnu": pnu, "format": "json", "numOfRows": "1",
                      "pageNo": "1"}
            res = requests.get(url, params=params, verify=False, timeout=5)
            if res.status_code == 200:
                item = res.json().get("ladfrlVOList", {}).get("ladfrlVOList", [{}])[0]
                area = item.get("lndpclAr", "")
                try:
                    area_fmt = f"{float(area) * 0.3025:,.2f}"
                except:
                    area_fmt = ""
                return {"ì§€ëª©": item.get("lndcgrCodeNm", ""), "ë©´ì ": area_fmt, "ì†Œìœ êµ¬ë¶„": item.get("posesnSeCodeNm", ""),
                        "ê³µìœ ì¸ìˆ˜": item.get("cnrsPsnCo", "")}
        except:
            pass
        return {"ì§€ëª©": "", "ë©´ì ": "", "ì†Œìœ êµ¬ë¶„": "", "ê³µìœ ì¸ìˆ˜": ""}

    # 3. ìš©ë„ì§€ì—­ ë° ê¸°íƒ€ êµ¬ì—­ (VWorld íŒŒì‹±)
    def get_land_use_detailed(pnu):
        if stop_event.is_set(): return {}

        base_data = {
            "ìš©ë„ì§€ì—­1": "", "ìš©ë„ì§€ì—­2": "", "ìš©ë„ì§€ì—­3": "",
            "ì§€êµ¬ë‹¨ìœ„ê³„íšêµ¬ì—­": "", "êµ­ê°€ì‚°ì—…ë‹¨ì§€": "", "ê°œë°œì œí•œêµ¬ì—­": "",
            "ê¸°íƒ€ìš©ë„ì§€ì—­": "", "ìš©ë„ì§€ì—­_ì½”ë“œëª…": ""
        }

        try:
            url = "https://api.vworld.kr/ned/wfs/getLandUseWFS"
            params = {"key": vworld_key, "domain": "landuse", "typename": "dt_d154", "pnu": pnu, "maxFeatures": "10",
                      "resultType": "results", "srsName": "EPSG:4326", "output": "application/json"}
            res = requests.get(url, params=params, verify=False, timeout=5)
            if res.status_code == 200:
                full_text = ""
                features = res.json().get("features", [])
                if features: full_text = features[0].get("properties", {}).get("prpos_area_dstrc_nm_list", "")

                items = [x.strip() for x in full_text.split(',')]
                core_list = []
                other_list = []
                CORE_KEYWORDS = ["ì£¼ê±°ì§€ì—­", "ìƒì—…ì§€ì—­", "ê³µì—…ì§€ì—­", "ë…¹ì§€ì§€ì—­", "ê´€ë¦¬ì§€ì—­", "ë†ë¦¼ì§€ì—­", "ìì—°í™˜ê²½ë³´ì „ì§€ì—­"]

                for item in items:
                    if not item: continue
                    is_core = False
                    for kw in CORE_KEYWORDS:
                        if kw in item:
                            core_list.append(item)
                            is_core = True
                            break

                    if "ì§€êµ¬ë‹¨ìœ„" in item:
                        base_data["ì§€êµ¬ë‹¨ìœ„ê³„íšêµ¬ì—­"] = item
                    elif "êµ­ê°€ì‚°ì—…ë‹¨ì§€" in item:
                        base_data["êµ­ê°€ì‚°ì—…ë‹¨ì§€"] = item
                    elif "ê°œë°œì œí•œêµ¬ì—­" in item:
                        base_data["ê°œë°œì œí•œêµ¬ì—­"] = item
                    elif not is_core:
                        other_list.append(item)

                for i in range(min(len(core_list), 3)):
                    base_data[f"ìš©ë„ì§€ì—­{i + 1}"] = core_list[i]

                base_data["ê¸°íƒ€ìš©ë„ì§€ì—­"] = ",".join(other_list)
                if core_list: base_data["ìš©ë„ì§€ì—­_ì½”ë“œëª…"] = core_list[0]

        except Exception as e:
            pass

        return base_data

    # 4. DB ê¸°ë°˜ í•œê³„ê°’ ì¡°íšŒ
    def get_db_info(pnu, zone_name):
        if not zone_name: return {"bc": "-", "vl": "-"}

        sigungu_code = pnu[:5]
        search_codes = [sigungu_code]

        if sigungu_code[4] != '0':
            parent_city_code = sigungu_code[:4] + '0'
            search_codes.append(parent_city_code)

        search_codes.extend([pnu[:4], pnu[:3], pnu[:2]])

        for code in search_codes:
            if code in CUSTOM_LIMIT_DB:
                zone_data = CUSTOM_LIMIT_DB[code]
                if zone_name in zone_data:
                    res = zone_data[zone_name]
                    debug_log(f"âœ… DB ë§¤ì¹­ ì„±ê³µ! Code:{code}")
                    return res

                clean_zone_name = zone_name.replace(" ", "")
                for db_zone, vals in zone_data.items():
                    if db_zone.replace(" ", "") == clean_zone_name:
                        return vals

        debug_log(f"âŒ DB ë§¤ì¹­ ì‹¤íŒ¨. (PNU:{pnu})")
        return {"bc": "-", "vl": "-"}

    # 5. ê±´ì¶•ë¬¼ëŒ€ì¥
    def get_building_info(pnu):
        if stop_event.is_set(): return {}
        try:
            pnu = str(pnu).strip()
            if len(pnu) != 19: return {}
            sigungu_cd = pnu[0:5];
            bjdong_cd = pnu[5:10];
            land_gb = pnu[10];
            bun = pnu[11:15];
            ji = pnu[15:19]
            plat_gb_cd = '0' if land_gb == '1' else ('1' if land_gb == '2' else '0')
            common_params = {'serviceKey': BUILDING_SERVICE_KEY, 'sigunguCd': sigungu_cd, 'bjdongCd': bjdong_cd,
                             'platGbCd': plat_gb_cd, 'bun': bun, 'ji': ji, 'pageNo': '1'}

            try:
                recap_params = common_params.copy();
                recap_params['numOfRows'] = '1'
                res_recap = requests.get(BUILDING_RECAP_API_URL, params=recap_params, timeout=5)
                if res_recap.status_code == 200:
                    data_recap = xmltodict.parse(res_recap.content)
                    if data_recap.get('response', {}).get('body', {}).get('totalCount') != '0':
                        item = data_recap['response']['body']['items']['item']
                        if isinstance(item, list): item = item[0]
                        return {'ê±´ë¬¼ëª…': item.get('bldNm', ''), 'ê±´ì¶•ë©´ì ': item.get('archArea', ''),
                                'ì—°ë©´ì ': item.get('totArea', ''), 'ê±´íìœ¨': item.get('bcRat', ''),
                                'ìš©ì ë¥ ': item.get('vlRat', ''), 'ìš©ì ë¥ _ìµœê³ ': item.get('vlRat', ''),
                                'ë†’ì´': item.get('heit', ''), 'ì§€ìƒì¸µìˆ˜': item.get('grndFlrCnt', ''),
                                'ì§€í•˜ì¸µìˆ˜': item.get('ugrndFlrCnt', ''), 'ì‚¬ìš©ìŠ¹ì¸ì¼': item.get('useAprDay', ''),
                                'ì£¼ìš©ë„': item.get('mainPurpsCdNm', '')}
            except:
                pass

            params = common_params.copy();
            params['numOfRows'] = '100'
            res = requests.get(BUILDING_API_URL, params=params, timeout=5)
            if res.status_code == 200:
                data = xmltodict.parse(res.content)
                if data.get('response', {}).get('body', {}).get('totalCount') == '0': return {}
                items = data['response']['body']['items']['item']
                if not isinstance(items, list): items = [items]
                bld_names = set();
                purps_names = set()
                arch_area_sum = 0.0;
                tot_area_sum = 0.0;
                max_bc_rat = 0.0;
                tot_vl_rat_sum = 0.0;
                max_vl_rat = 0.0;
                max_heit = 0.0;
                max_grnd = 0;
                max_ugrnd = 0;
                max_use_apr = ""
                for item in items:
                    nm = item.get('bldNm');
                    if nm: bld_names.add(nm)
                    purp = item.get('mainPurpsCdNm');
                    if purp: purps_names.add(purp)
                    try:
                        arch_area_sum += float(item.get('archArea') or 0)
                    except:
                        pass
                    try:
                        tot_area_sum += float(item.get('totArea') or 0)
                    except:
                        pass
                    try:
                        max_bc_rat = max(max_bc_rat, float(item.get('bcRat') or 0))
                    except:
                        pass
                    try:
                        vl = float(item.get('vlRat') or 0); tot_vl_rat_sum += vl; max_vl_rat = max(max_vl_rat, vl)
                    except:
                        pass
                    try:
                        max_heit = max(max_heit, float(item.get('heit') or 0))
                    except:
                        pass
                    try:
                        max_grnd = max(max_grnd, int(item.get('grndFlrCnt') or 0))
                    except:
                        pass
                    try:
                        max_ugrnd = max(max_ugrnd, int(item.get('ugrndFlrCnt') or 0))
                    except:
                        pass
                    apr = item.get('useAprDay') or ""
                    if apr > max_use_apr: max_use_apr = apr
                return {'ê±´ë¬¼ëª…': ",".join(sorted(list(bld_names))), 'ê±´ì¶•ë©´ì ': str(arch_area_sum), 'ì—°ë©´ì ': str(tot_area_sum),
                        'ê±´íìœ¨': str(max_bc_rat) if max_bc_rat > 0 else '',
                        'ìš©ì ë¥ ': str(tot_vl_rat_sum) if tot_vl_rat_sum > 0 else '',
                        'ìš©ì ë¥ _ìµœê³ ': str(max_vl_rat) if max_vl_rat > 0 else '', 'ë†’ì´': str(max_heit), 'ì§€ìƒì¸µìˆ˜': str(max_grnd),
                        'ì§€í•˜ì¸µìˆ˜': str(max_ugrnd), 'ì‚¬ìš©ìŠ¹ì¸ì¼': max_use_apr, 'ì£¼ìš©ë„': ",".join(sorted(list(purps_names)))}
        except:
            pass
        return {}

    # 5. GeoJSON ì¡°íšŒ (ë©”ì¸ ì‹¤í–‰ë¶€)
    if stop_event.is_set(): raise InterruptedError("Stopped")
    url = "http://api.vworld.kr/req/data"
    params = {"service": "data", "request": "GetFeature", "key": vworld_key, "data": "LP_PA_CBND_BUBUN",
              "attrFilter": f"pnu:=:{pnu}", "format": "json", "crs": "EPSG:4326"}

    for _ in range(3):
        if stop_event.is_set(): raise InterruptedError("Stopped")
        try:
            res = requests.get(url, params=params, timeout=10)
            if res.status_code == 200:
                data = res.json()
                features = (data.get("features") or data.get("result", {}).get("featureCollection", {}).get(
                    "features") or data.get("response", {}).get("result", {}).get("featureCollection", {}).get(
                    "features"))
                if features:
                    debug_log(f"GeoJSON ìˆ˜ì‹  ì„±ê³µ: {pnu}")
                    price_val = get_official_price(pnu)

                    luris_info = get_land_use_detailed(pnu)
                    lad_info = get_ladfrl_details(pnu)
                    bld_info = get_building_info(pnu)

                    db_info = get_db_info(pnu, luris_info.get("ìš©ë„ì§€ì—­_ì½”ë“œëª…", ""))

                    for f in features:
                        if "properties" not in f: f["properties"] = {}
                        f["properties"]["ê³µì‹œì§€ê°€"] = price_val
                        f["properties"].update(luris_info)
                        f["properties"].update(lad_info)
                        f["properties"].update(bld_info)
                        f["properties"]["í•œê³„ê±´íìœ¨"] = db_info.get('bc')
                        f["properties"]["í•œê³„ìš©ì ë¥ "] = db_info.get('vl')
                    return {"type": "FeatureCollection", "features": features}
                else:
                    debug_log(f"GeoJSON ë°ì´í„° ì—†ìŒ: {pnu}")
            else:
                debug_log(f"API ìš”ì²­ ì‹¤íŒ¨: {res.status_code}")
        except Exception as e:
            debug_log(f"API ìš”ì²­ ì˜ˆì™¸: {e}")
            time.sleep(0.5)

    raise ValueError("API ë°ì´í„° ì—†ìŒ")


def get_center_from_geojson(geojson):
    coords = geojson['features'][0]['geometry']['coordinates'][0][0]
    lons, lats = zip(*coords)
    return sum(lats) / len(lats), sum(lons) / len(lons)


# ====== 5. ì§€ë„ ìƒì„± í•¨ìˆ˜ ======
def create_map_with_outer_and_inner_layers(geojson, address_list, address_styles, stroke_color='#FFA500',
                                           fill_color='#ffffff',
                                           fill_opacity=0.2, stroke_weight=2):
    result_dir = os.path.join(base_dir, "result")
    if not os.path.exists(result_dir):
        os.makedirs(result_dir)

    filename = simpledialog.askstring("ì§€ë„ ì €ì¥", "ì €ì¥í•  ì§€ë„ íŒŒì¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš” (í™•ì¥ì ì œì™¸):")
    if not filename:
        return

    output_file = os.path.join(result_dir, f"{filename}.html")

    if geojson['features']:
        for f in geojson['features']:
            p = f.get('properties', {})
            if 'ê±´ë¬¼ëª…' not in p: p['ê±´ë¬¼ëª…'] = "-"

            tot_area = p.get('ì—°ë©´ì ', '')
            if tot_area:
                try:
                    p['ì—°ë©´ì _fmt'] = f"{float(tot_area) * 0.3025:,.0f}í‰"
                except:
                    p['ì—°ë©´ì _fmt'] = "-"
            else:
                p['ì—°ë©´ì _fmt'] = "-"

            own = p.get('ì†Œìœ êµ¬ë¶„', '-')
            share = p.get('ê³µìœ ì¸ìˆ˜', '0')
            p['ì†Œìœ _fmt'] = f"{own}({share})"

            # [ë³€ê²½] íˆ´íŒ í¬ë§·íŒ… (í˜„í™© / í•œê³„)
            # ì˜ˆ: 59.9 / 60
            curr_bc = p.get('ê±´íìœ¨', '') if p.get('ê±´íìœ¨', '') else '-'
            limit_bc = p.get('í•œê³„ê±´íìœ¨', '') if p.get('í•œê³„ê±´íìœ¨', '') else '-'
            p['tooltip_bc'] = f"{curr_bc} / {limit_bc}"

            curr_vl = p.get('ìš©ì ë¥ ', '') if p.get('ìš©ì ë¥ ', '') else '-'
            limit_vl = p.get('í•œê³„ìš©ì ë¥ ', '') if p.get('í•œê³„ìš©ì ë¥ ', '') else '-'
            p['tooltip_vl'] = f"{curr_vl} / {limit_vl}"

            # [ì¶”ê°€] ì§€êµ¬ë‹¨ìœ„ê³„íš ë° ë¹„ê³  í‘œì‹œ
            district = p.get('ì§€êµ¬ë‹¨ìœ„ê³„íšêµ¬ì—­', '')
            if district:
                p['district_fmt'] = district
                p['remark_fmt'] = "âš ï¸ì§€êµ¬ë‹¨ìœ„ê³„íšêµ¬ì—­ìƒ ê±´íìœ¨/ìš©ì ë¥  í™•ì¸ í•„ìˆ˜!"
            else:
                p['district_fmt'] = "-"
                p['remark_fmt'] = "-"

            for key in ['addr', 'ì§€ëª©', 'ë©´ì ', 'ê³µì‹œì§€ê°€', 'ìš©ë„ì§€ì—­1', 'ê°œë°œì œí•œêµ¬ì—­']:
                if key not in p: p[key] = "-"

    if not geojson['features']:
        lat, lon = 37.361446, 127.111488
    else:
        lat, lon = get_center_from_geojson(geojson)

    m = folium.Map(location=[lat, lon], zoom_start=18, tiles=None)

    folium.TileLayer(tiles=f"https://api.vworld.kr/req/wmts/1.0.0/{vworld_key}/Satellite/{{z}}/{{y}}/{{x}}.jpeg",
                     attr='VWorld Satellite', name='ìœ„ì„±ì§€ë„', overlay=False, control=True).add_to(m)
    folium.TileLayer(tiles=f"https://api.vworld.kr/req/wmts/1.0.0/{vworld_key}/Base/{{z}}/{{y}}/{{x}}.png",
                     attr='VWorld Base', name='ì¼ë°˜ì§€ë„', overlay=False, control=True).add_to(m)
    folium.TileLayer(tiles=f"https://api.vworld.kr/req/wmts/1.0.0/{vworld_key}/gray/{{z}}/{{y}}/{{x}}.png",
                     attr='VWorld Gray', name='íšŒìƒ‰ì§€ë„', overlay=False, control=True).add_to(m)
    folium.TileLayer(tiles=f"https://api.vworld.kr/req/wmts/1.0.0/{vworld_key}/Hybrid/{{z}}/{{y}}/{{x}}.png",
                     attr='VWorld Hybrid', name='í•˜ì´ë¸Œë¦¬ë“œ(ë„ë¡œ/ì§€ëª…)', overlay=True, control=True).add_to(m)

    def analysis_style_function(feature):
        props = feature['properties']
        addr = props.get('addr', '')
        if addr in address_styles:
            st = address_styles[addr]
            return {'fillColor': st.get('fill', fill_color), 'color': st.get('stroke', stroke_color),
                    'weight': stroke_weight, 'fillOpacity': st.get('opacity', fill_opacity)}
        owner = props.get('ì†Œìœ êµ¬ë¶„', '')
        try:
            share_cnt = int(props.get('ê³µìœ ì¸ìˆ˜', 0))
        except:
            share_cnt = 0
        if 'ê°œì¸' in owner:
            base_color = '#FFD600'
        elif any(x in owner for x in ['êµ­', 'ë„', 'ì‹œ', 'êµ°']):
            base_color = '#1565C0'
        elif 'ë²•ì¸' in owner:
            base_color = '#D32F2F'
        else:
            base_color = '#757575'
        if share_cnt == 0:
            opacity = 0.2
        elif 1 <= share_cnt <= 2:
            opacity = 0.4
        elif 3 <= share_cnt <= 5:
            opacity = 0.6
        elif 6 <= share_cnt <= 10:
            opacity = 0.7
        elif 11 <= share_cnt <= 20:
            opacity = 0.8
        else:
            opacity = 0.9
        return {'fillColor': base_color, 'color': 'white', 'weight': 2, 'fillOpacity': opacity}

    def clean_style_function(feature):
        return {'fillColor': 'none', 'color': 'white', 'weight': 2, 'fillOpacity': 0}

    if geojson['features']:
        analysis_group = folium.FeatureGroup(name="ì†Œìœ ì£¼ ë¶„ì„ë„", show=True)
        folium.GeoJson(
            geojson,
            style_function=analysis_style_function,
            tooltip=folium.GeoJsonTooltip(
                fields=['addr', 'ì§€ëª©', 'ë©´ì ', 'ê³µì‹œì§€ê°€', 'ì†Œìœ _fmt', 'ìš©ë„ì§€ì—­1', 'tooltip_bc', 'tooltip_vl', 'district_fmt',
                        'remark_fmt', 'ê±´ë¬¼ëª…', 'ì—°ë©´ì _fmt'],
                aliases=['ì£¼ì†Œ', 'ì§€ëª©', 'ë©´ì (í‰)', 'ê³µì‹œì§€ê°€', 'ì†Œìœ ', 'ìš©ë„', 'ê±´íìœ¨(í˜„í™©/í•œê³„)', 'ìš©ì ë¥ (í˜„í™©/í•œê³„)', 'ì§€êµ¬ë‹¨ìœ„ê³„íš', 'ë¹„ê³ ', 'ê±´ë¬¼ëª…',
                         'ì—°ë©´ì '],
                labels=True
            )
        ).add_to(analysis_group)
        analysis_group.add_to(m)

        clean_group = folium.FeatureGroup(name="ê¸°ë³¸ ì§€ì ë„(ì„ )", show=False)
        folium.GeoJson(geojson, style_function=clean_style_function, tooltip=None).add_to(clean_group)
        clean_group.add_to(m)

        try:
            polys = [shape(f['geometry']) for f in geojson['features']]
            from shapely.ops import unary_union
            merged = unary_union(polys)
            merged_gdf = gpd.GeoDataFrame(geometry=[merged])
            merged_geojson = json.loads(merged_gdf.to_json())
            folium.GeoJson(merged_geojson, name="ì „ì²´ ì™¸ê³½ì„ ",
                           style_function=lambda x: {'fillColor': 'none', 'color': 'white', 'weight': 4,
                                                     'fillOpacity': 0}, tooltip=None).add_to(m)
        except:
            pass

    folium.WmsTileLayer(url=f"http://api.vworld.kr/req/wms?key={vworld_key}", name="ê°œë°œì œí•œêµ¬ì—­", layers="lt_c_ud801",
                        fmt="image/png", transparent=True, version="1.3.0", attr="VWorld", overlay=True, control=True,
                        show=True).add_to(m)
    folium.WmsTileLayer(url=f"https://ecvam.neins.go.kr/apicall.do?APIKEY=RFW3-NXDZ-3CID-JAWS", name="ê³µìµìš©ì‚°ì§€",
                        layers="nem_law_42", fmt="image/png", transparent=True, version="1.1.0", attr="ì‚°ì§€ì •ë³´ì‹œìŠ¤í…œ",
                        overlay=True, control=True, show=True, opacity=0.1).add_to(m)

    folium.LayerControl(position='topleft', collapsed=False).add_to(m)

    legend_html = """
        <div style="position: fixed; bottom: 30px; right: 10px; width: 200px; height: auto; 
                    border:2px solid grey; z-index:9998; font-size:12px; background-color:white;
                    padding: 10px; border-radius: 5px; box-shadow: 2px 2px 5px rgba(0,0,0,0.3);">
            <h5 style="margin-top:0; text-align:center;">ğŸ“Œ ì†Œìœ ì£¼ ë²”ë¡€</h5>
            <div style="margin-bottom:5px;"><span style="background:#FFD600; opacity:0.7; width:15px; height:15px; display:inline-block; vertical-align:middle; border:1px solid #ccc;"></span> ê°œì¸ (ë…¸ë‘)</div>
            <div style="margin-bottom:5px;"><span style="background:#1565C0; opacity:0.7; width:15px; height:15px; display:inline-block; vertical-align:middle;"></span> êµ­/ê³µìœ  (íŒŒë‘)</div>
            <div style="margin-bottom:5px;"><span style="background:#D32F2F; opacity:0.7; width:15px; height:15px; display:inline-block; vertical-align:middle;"></span> ë²•ì¸ (ë¹¨ê°•)</div>
            <div style="margin-bottom:10px;"><span style="background:#757575; opacity:0.7; width:15px; height:15px; display:inline-block; vertical-align:middle;"></span> ê¸°íƒ€ (íšŒìƒ‰)</div>
            <hr>
            <div style="text-align:center; font-size:11px; margin-bottom:5px;">ê³µìœ ì¸ìˆ˜ (ì§„í• ìˆ˜ë¡ ë§ìŒ)</div>
            <div style="background: linear-gradient(to right, rgba(0,0,0,0.2), rgba(0,0,0,0.9)); height: 10px; border:1px solid #ccc; margin-bottom: 2px;"></div>
            <div style="display:flex; justify-content:space-between; font-size:10px; color:#555;"><span>0</span><span>1~3</span><span>4~10</span><span>11~20</span><span>21+</span></div>
        </div>
        """
    m.get_root().html.add_child(folium.Element(legend_html))

    save_data = {"addresses": address_list, "styles": address_styles}
    data_str = json.dumps(save_data, ensure_ascii=False)
    m.get_root().html.add_child(
        folium.Element(f'<script id="saved-map-data" type="application/json">{data_str}</script>'))

    control_html = f"""
    <div id="ui-controls" style="
        position: fixed; top: 10px;
        right: 10px; width: 220px;
        background-color: white; padding: 15px; border: 2px solid black;
        z-index: 9999; font-family: sans-serif;
        box-shadow: 3px 3px 5px rgba(0,0,0,0.3); border-radius: 8px;
        max-height: 90vh; overflow-y: auto;">
        <h4 style="margin-top:0; margin-bottom:10px;">ğŸ› ï¸ ì§€ë„ ìŠ¤íƒ€ì¼</h4>
        <div id="selectionStatus" style="background: #eee; padding: 8px; margin-bottom: 10px; border-radius: 4px; font-size: 13px; font-weight: bold; color: #333;">í˜„ì¬: ì „ì²´ í•„ì§€ ìˆ˜ì • ì¤‘</div>
        <button onclick="resetSelection()" style="width:100%; padding:5px; margin-bottom:10px; background:#f44336; color:white; border:none; border-radius:4px; cursor:pointer;">ì „ì²´ ëª¨ë“œë¡œ ë³µê·€</button>
        <hr style="margin-bottom:10px;">
        <label style="font-size:12px;"><b>ì„  ìƒ‰ìƒ</b></label>
        <input type="color" id="strokeColor" value="{stroke_color}" style="width:40px; float:right; cursor:pointer;"><br style="clear:both; margin-bottom:5px;">
        <label style="font-size:12px;"><b>ì„  ë‘ê»˜: <span id="weightVal">{stroke_weight}</span>px</b></label>
        <input type="range" id="strokeWeight" min="0" max="10" step="1" value="{stroke_weight}" style="width:100%; cursor:pointer;" oninput="document.getElementById('weightVal').innerText=this.value"><br>
        <label style="font-size:12px;"><b>ì±„ì›€ ìƒ‰ìƒ</b></label>
        <input type="color" id="fillColor" value="{fill_color}" style="width:40px; float:right; cursor:pointer;"><br style="clear:both; margin-bottom:5px;">
        <label style="font-size:12px;"><b>íˆ¬ëª…ë„: <span id="opVal">{fill_opacity}</span></b></label>
        <input type="range" id="fillOpacity" min="0" max="1" step="0.1" value="{fill_opacity}" style="width:100%; cursor:pointer;" oninput="document.getElementById('opVal').innerText=this.value">
        <br><br>
        <button onclick="updateMapStyle()" style="width:100%; padding:10px; background:#4CAF50; color:white; border:none; border-radius:4px; font-weight:bold; cursor:pointer;">ìŠ¤íƒ€ì¼ ì ìš©í•˜ê¸°</button>
        <hr style="margin-top:15px; margin-bottom:15px;">
        <button onclick="downloadMap()" style="width:100%; padding:10px; background:#2196F3; color:white; border:none; border-radius:4px; font-weight:bold; cursor:pointer;">ğŸ’¾ í˜„ì¬ ìƒíƒœ ì €ì¥(ë‹¤ìš´ë¡œë“œ)</button>
        <p style="font-size:11px; color:gray; margin-top:5px;">* ìˆ˜ì •í•œ ë‚´ìš©ì„ ì €ì¥í•˜ë ¤ë©´ ìœ„ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìƒˆ íŒŒì¼ì„ ë°›ìœ¼ì„¸ìš”.</p>
    </div>
    <script>
        var selectedLayer = null; 
        window.onload = function() {{ initLayerClicks(); }};
        function findMapInstance() {{ for (var key in window) {{ if (window[key] instanceof L.Map) return window[key]; }} return null; }}
        function initLayerClicks() {{
            var mapInstance = findMapInstance();
            if (!mapInstance) {{ setTimeout(initLayerClicks, 500); return; }}
            mapInstance.eachLayer(function(layer) {{
                if (layer.feature && layer.setStyle && layer.options && layer.options.fillOpacity !== 0) {{
                    layer.on('click', function(e) {{ selectedLayer = e.target; var props = selectedLayer.feature.properties; var addr = props.addr || "ì„ íƒëœ í•„ì§€"; document.getElementById('selectionStatus').innerHTML = "í˜„ì¬: <span style='color:blue;'>" + addr + "</span> ìˆ˜ì • ì¤‘"; document.getElementById('selectionStatus').style.background = "#e3f2fd"; L.DomEvent.stopPropagation(e); }});
                }}
            }});
        }}
        function resetSelection() {{ selectedLayer = null; document.getElementById('selectionStatus').innerHTML = "í˜„ì¬: ì „ì²´ í•„ì§€ ìˆ˜ì • ì¤‘"; document.getElementById('selectionStatus').style.background = "#eee"; }}
        function updateMapStyle() {{
            var stroke = document.getElementById('strokeColor').value;
            var fill = document.getElementById('fillColor').value;
            var opacity = parseFloat(document.getElementById('fillOpacity').value);
            var weight = parseInt(document.getElementById('strokeWeight').value);
            if (selectedLayer) {{ 
                selectedLayer.setStyle({{ color: stroke, weight: weight, fillColor: fill, fillOpacity: opacity }});
                var dataTag = document.getElementById('saved-map-data');
                var addr = selectedLayer.feature.properties.addr;
                if (dataTag && addr) {{
                    try {{ var data = JSON.parse(dataTag.textContent); if (!data.styles) data.styles = {{}}; data.styles[addr] = {{ 'stroke': stroke, 'fill': fill, 'opacity': opacity }}; dataTag.textContent = JSON.stringify(data); }} catch(e) {{ }}
                }}
            }} else {{ 
                var mapInstance = findMapInstance();
                if (!mapInstance) return; 
                mapInstance.eachLayer(function(layer) {{ if (layer.feature && layer.setStyle && layer.options && layer.options.fillOpacity !== 0) {{ layer.setStyle({{ color: stroke, weight: weight, fillColor: fill, fillOpacity: opacity }}); }} }});
            }}
        }}
        function downloadMap() {{
            var htmlContent = document.documentElement.outerHTML;
            var blob = new Blob([htmlContent], {{type: 'text/html'}});
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'modified_map.html'; 
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }}
    </script>
    """
    m.get_root().html.add_child(folium.Element(control_html))
    m.save(output_file)
    try:
        webbrowser.open(output_file)
    except:
        pass


def run_gui():
    root = tk.Tk()
    root.title("ì§€ì ë„ GUI by chanyoung)")
    root.geometry("970x570")

    address_list = []
    address_styles = {}

    stroke_color_var = tk.StringVar(value="#FFA500")
    fill_color_var = tk.StringVar(value="#ffffff")
    fill_opacity_var = tk.DoubleVar(value=0.2)
    stroke_weight_var = tk.IntVar(value=2)

    def add_addr():
        sido = sido_var.get()
        sigungu = sigungu_var.get()
        dong = dong_entry.get().strip()
        jibun = jibun_entry.get().strip()
        if not (sido and sigungu and dong and jibun):
            messagebox.showerror("ì˜¤ë¥˜", "ëª¨ë“  ì£¼ì†Œ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
            return
        full_address = f"{sido} {sigungu} {dong} {jibun}"
        if full_address in address_list:
            messagebox.showinfo("ì•Œë¦¼", "ì´ë¯¸ ë¦¬ìŠ¤íŠ¸ì— ì¡´ì¬í•˜ëŠ” ì£¼ì†Œì…ë‹ˆë‹¤.")
            return
        address_list.append(full_address)
        checklist.insert(tk.END, full_address)

    def add_sigungu_to_addresses():
        sido = sido_var.get()
        sigungu = sigungu_var.get()
        if not sido:
            messagebox.showerror("ì˜¤ë¥˜", "ì‹œë„ë¥¼ ì„ íƒí•˜ì„¸ìš”.")
            return
        prefix = sido if not sigungu else f"{sido} {sigungu}"
        for i in range(len(address_list)):
            addr = address_list[i]
            if addr.startswith(f"{prefix} "): continue
            address_list[i] = f"{prefix} {addr}"
        checklist.delete(0, tk.END)
        for addr in address_list: checklist.insert(tk.END, addr)
        messagebox.showinfo("ì™„ë£Œ", f"{prefix}ê°€ ì£¼ì†Œ ì•ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.")

    def csv_import():
        base_dir = os.path.dirname(sys.executable) if getattr(sys, 'frozen', False) else os.path.dirname(
            os.path.abspath(__file__))
        csv_file = os.path.join(base_dir, "input.csv")
        if not os.path.exists(csv_file):
            messagebox.showerror("ì˜¤ë¥˜", "input.csv íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
            return
        try:
            df = pd.read_csv(csv_file, encoding="utf-8-sig")
            count_added = 0
            count_dup = 0
            for row in df.iloc[:, 0]:
                addr = str(row).strip()
                if addr:
                    if addr not in address_list:
                        address_list.append(addr)
                        checklist.insert("end", addr)
                        count_added += 1
                    else:
                        count_dup += 1
            if count_dup > 0:
                messagebox.showinfo("ì™„ë£Œ", f"{count_added}ê°œ ì¶”ê°€ ì™„ë£Œ.\n(ì¤‘ë³µ {count_dup}ê±´ ì œì™¸)")
            else:
                messagebox.showinfo("ì™„ë£Œ", f"{count_added}ê°œ ì£¼ì†Œ ì¶”ê°€ ì™„ë£Œ.")
        except Exception as e:
            messagebox.showerror("CSV íŒŒì¼ ì½ê¸° ì˜¤ë¥˜", str(e))

    def delete_selected():
        selected = checklist.curselection()
        for index in reversed(selected):
            checklist.delete(index)
            del address_list[index]

    def standardize_addresses():
        if not address_list:
            messagebox.showinfo("ì•ˆë‚´", "í‘œì¤€í™”í•  ì£¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.")
            return
        sido_mapping = {
            "ì„œìš¸": "ì„œìš¸íŠ¹ë³„ì‹œ", "ë¶€ì‚°": "ë¶€ì‚°ê´‘ì—­ì‹œ", "ëŒ€êµ¬": "ëŒ€êµ¬ê´‘ì—­ì‹œ", "ì¸ì²œ": "ì¸ì²œê´‘ì—­ì‹œ",
            "ê´‘ì£¼": "ê´‘ì£¼ê´‘ì—­ì‹œ", "ëŒ€ì „": "ëŒ€ì „ê´‘ì—­ì‹œ", "ìš¸ì‚°": "ìš¸ì‚°ê´‘ì—­ì‹œ", "ì„¸ì¢…": "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ",
            "ê²½ê¸°": "ê²½ê¸°ë„", "ê°•ì›": "ê°•ì›íŠ¹ë³„ìì¹˜ë„", "ì¶©ë¶": "ì¶©ì²­ë¶ë„", "ì¶©ë‚¨": "ì¶©ì²­ë‚¨ë„",
            "ì „ë¶": "ì „ë¶íŠ¹ë³„ìì¹˜ë„", "ì „ë‚¨": "ì „ë¼ë‚¨ë„", "ê²½ë¶": "ê²½ìƒë¶ë„", "ê²½ë‚¨": "ê²½ìƒë‚¨ë„",
            "ì œì£¼": "ì œì£¼íŠ¹ë³„ìì¹˜ë„"
        }
        sido_pattern = "|".join(sido_mapping.keys())

        def normalize_address(addr):
            addr = re.sub(r"\(.*?\)", "", addr).strip()
            match = re.match(rf"({sido_pattern})(ì‹œ|ë„|ê´‘ì—­ì‹œ|íŠ¹ë³„ì‹œ|íŠ¹ë³„ìì¹˜ì‹œ|íŠ¹ë³„ìì¹˜ë„)?", addr)
            if match:
                raw_sido = match.group(1)
                full_sido = sido_mapping.get(raw_sido, raw_sido)
                rest = addr[match.end():].lstrip()
                return f"{full_sido} {rest}".strip()
            for sido, sigungus in sigungu_dict.items():
                for sigungu in sigungus:
                    if addr.startswith(sigungu):
                        rest = addr[len(sigungu):].lstrip()
                        return f"{sido} {sigungu} {rest}".strip()
            return addr.strip()

        for i in range(len(address_list)): address_list[i] = normalize_address(address_list[i])
        checklist.delete(0, tk.END)
        for addr in address_list: checklist.insert(tk.END, addr)
        messagebox.showinfo("ì™„ë£Œ", "ì£¼ì†Œ í‘œì¤€í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")

    def load_map_from_html():
        result_dir = os.path.join(base_dir, "result")
        if not os.path.exists(result_dir): messagebox.showinfo("ì•Œë¦¼", "result í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤."); return
        files = [f for f in os.listdir(result_dir) if f.endswith(".html")]
        if not files: messagebox.showinfo("ì•Œë¦¼", "ì €ì¥ëœ ì§€ë„ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."); return
        top = tk.Toplevel(root)
        top.title("ì§€ë„ ë¶ˆëŸ¬ì˜¤ê¸°")
        top.geometry("300x400")
        tk.Label(top, text="ë¶ˆëŸ¬ì˜¬ ì§€ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”:").pack(pady=10)
        listbox = tk.Listbox(top, selectmode=tk.SINGLE)
        listbox.pack(expand=True, fill="both", padx=10, pady=5)
        for f in files: listbox.insert(tk.END, f)

        def do_load():
            selection = listbox.curselection()
            if not selection: return
            filename = listbox.get(selection[0])
            fpath = os.path.join(result_dir, filename)
            top.destroy()
            try:
                with open(fpath, 'r', encoding='utf-8') as f:
                    content = f.read()
                match = re.search(r'<script id="saved-map-data" type="application/json">(.*?)</script>', content)
                if match:
                    data = json.loads(match.group(1))
                    address_list.clear()
                    checklist.delete(0, tk.END)
                    address_styles.clear()
                    loaded_addrs = data.get('addresses', [])
                    loaded_styles = data.get('styles', {})
                    for addr in loaded_addrs:
                        address_list.append(addr)
                        checklist.insert(tk.END, addr)
                    for k, v in loaded_styles.items(): address_styles[k] = v
                    messagebox.showinfo("ì™„ë£Œ", f"'{filename}'ì—ì„œ {len(loaded_addrs)}ê°œì˜ ì£¼ì†Œë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.")
                else:
                    messagebox.showerror("ì‹¤íŒ¨", "ì§€ë„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
            except Exception as e:
                messagebox.showerror("ì˜¤ë¥˜", f"íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: {e}")

        tk.Button(top, text="ì„ íƒí•œ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°", command=do_load, bg="#4CAF50", fg="white").pack(pady=10, fill='x', padx=10)

    def apply_style_to_selected():
        selected_indices = checklist.curselection()
        if not selected_indices: messagebox.showwarning("ì•Œë¦¼", "ì„ íƒëœ ì£¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤."); return
        style = {"stroke": stroke_color_var.get(), "fill": fill_color_var.get(), "opacity": fill_opacity_var.get()}
        for i in selected_indices:
            addr = checklist.get(i)
            address_styles[addr] = style.copy()
        messagebox.showinfo("ì™„ë£Œ", "ì„ íƒëœ ì£¼ì†Œì— ìŠ¤íƒ€ì¼ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.")

    def process_address_worker(addr, stop_event):
        try:
            if stop_event.is_set(): return []
            try:
                pnu = address_to_pnu(addr)
            except Exception as e:
                return [{"type": "Feature", "geometry": None,
                         "properties": {"addr": addr, "ì§€ëª©": "ì‹¤íŒ¨", "ê±´ë¬¼ëª…": f"ì£¼ì†Œì˜¤ë¥˜: {str(e)}"}}]

            try:
                gj = get_geojson_by_pnu(pnu, stop_event)
                processed = []
                if gj and "features" in gj:
                    for f in gj["features"]:
                        if "properties" not in f: f["properties"] = {}
                        f["properties"]["addr"] = addr
                        processed.append(f)
                return processed
            except Exception as e:
                return [{"type": "Feature", "geometry": None,
                         "properties": {"addr": addr, "ì§€ëª©": "ì‹¤íŒ¨", "ê±´ë¬¼ëª…": f"APIì˜¤ë¥˜: {str(e)}"}}]
        except:
            return [{"type": "Feature", "geometry": None, "properties": {"addr": addr, "ì§€ëª©": "ì‹¤íŒ¨", "ê±´ë¬¼ëª…": "ì•Œìˆ˜ì—†ëŠ” ì˜¤ë¥˜"}}]

    def run_process(mode="map"):
        if not address_list and mode == "excel": messagebox.showerror("ì˜¤ë¥˜", "ì£¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤."); return

        title_text = "ì§€ë„ ë°ì´í„° ìƒì„± ì¤‘..." if mode == "map" else "ì—‘ì…€ ë°ì´í„° ìˆ˜ì§‘ ì¤‘..."
        progress_win = tk.Toplevel()
        progress_win.title(title_text)
        progress_win.geometry("400x150")

        lbl_status = tk.Label(progress_win, text=f"ì´ {len(address_list)}ê°œ ì²˜ë¦¬ ì‹œì‘ (ì•ˆì „ëª¨ë“œ)...")
        lbl_status.pack(pady=10)
        progress_bar = ttk.Progressbar(progress_win, maximum=len(address_list), length=300, mode="determinate")
        progress_bar.pack(pady=10)
        stop_event = threading.Event()

        def on_stop():
            stop_event.set()
            lbl_status.config(text="ğŸ›‘ ì¤‘ë‹¨ ìš”ì²­ë¨! ë§ˆë¬´ë¦¬ ì¤‘...")
            btn_stop.config(state="disabled")

        btn_stop = tk.Button(progress_win, text="ì¤‘ë‹¨ ë° ì €ì¥", command=on_stop, bg="#ffdddd")
        btn_stop.pack(pady=5)

        def run_thread():
            global excel_features
            with data_lock:
                excel_features = []
            with ThreadPoolExecutor(max_workers=10) as executor:
                future_to_addr = {executor.submit(process_address_worker, addr, stop_event): addr for addr in
                                  address_list}
                count = 0
                for future in concurrent.futures.as_completed(future_to_addr):
                    if stop_event.is_set() or not progress_win.winfo_exists(): break
                    try:
                        res = future.result()
                        if res:
                            with data_lock: excel_features.extend(res)
                    except:
                        pass
                    count += 1
                    try:
                        progress_bar["value"] = count
                        if count % 10 == 0 or count == len(address_list): lbl_status.config(
                            text=f"ì§„í–‰: {count} / {len(address_list)} ({(count / len(address_list)) * 100:.1f}%)")
                        progress_win.update_idletasks()
                    except:
                        pass
            if progress_win.winfo_exists(): progress_win.destroy()
            if not excel_features:
                if mode == "excel": messagebox.showerror("ì‹¤íŒ¨", "ìˆ˜ì§‘ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
                return

            # ì‹¤íŒ¨ê±´ ì¹´ìš´íŠ¸
            fail_count = len([f for f in excel_features if f.get('properties', {}).get('ì§€ëª©') == 'ì‹¤íŒ¨'])
            success_count = len(excel_features) - fail_count

            if success_count == 0 and fail_count > 0:
                messagebox.showerror("API ì˜¤ë¥˜", "ëª¨ë“  ì£¼ì†Œ ìˆ˜ì§‘ ì‹¤íŒ¨.")
            elif fail_count > 0:
                messagebox.showwarning("ì™„ë£Œ (ì¼ë¶€ ì‹¤íŒ¨)", f"{success_count}ê±´ ì„±ê³µ, {fail_count}ê±´ ì‹¤íŒ¨.")
            else:
                messagebox.showinfo("ì™„ë£Œ", f"{success_count}ê±´ ì„±ê³µ!")

            if mode == "map":
                valid_features = [f for f in excel_features if f.get('geometry')]
                unique_valid = []
                seen = set()
                for f in valid_features:
                    addr = f['properties'].get('addr')
                    if addr and addr not in seen:
                        seen.add(addr)
                        unique_valid.append(f)
                if not unique_valid: return
                features_collection = {"type": "FeatureCollection", "features": unique_valid}
                root.after(0, lambda: create_map_with_outer_and_inner_layers(features_collection, address_list,
                                                                             address_styles, stroke_color_var.get(),
                                                                             fill_color_var.get(),
                                                                             fill_opacity_var.get(),
                                                                             stroke_weight_var.get()))
            else:
                root.after(0, save_to_excel)

        threading.Thread(target=run_thread, daemon=True).start()

    frame_top = tk.Frame(root)
    frame_top.pack(fill="x", padx=10, pady=5)
    tk.Label(frame_top, text="ì‹œë„").pack(side="left")
    sido_var = tk.StringVar()
    sido_combo = ttk.Combobox(frame_top, textvariable=sido_var, values=sido_list, state="readonly", width=14)
    sido_combo.pack(side="left", padx=2)
    sido_combo.bind("<<ComboboxSelected>>",
                    lambda e: sigungu_combo.config(values=sigungu_dict.get(sido_var.get(), [])) or sigungu_var.set(""))
    tk.Label(frame_top, text="ì‹œêµ°êµ¬").pack(side="left")
    sigungu_var = tk.StringVar()
    sigungu_combo = ttk.Combobox(frame_top, textvariable=sigungu_var, state="readonly", width=16)
    sigungu_combo.pack(side="left", padx=2)
    tk.Label(frame_top, text="ë™").pack(side="left")
    dong_entry = tk.Entry(frame_top, width=10)
    dong_entry.pack(side="left", padx=2)
    tk.Label(frame_top, text="ì§€ë²ˆ").pack(side="left")
    jibun_entry = tk.Entry(frame_top, width=10)
    jibun_entry.pack(side="left", padx=2)
    tk.Button(frame_top, text="ì£¼ì†Œ ì¶”ê°€", width=10, command=add_addr).pack(side="left", padx=(10, 2))

    frame_main = tk.Frame(root)
    frame_main.pack(fill="both", expand=True, padx=10, pady=10)
    frame_left = tk.LabelFrame(frame_main, text="ê¸°ëŠ¥ ì‹¤í–‰", bd=2, relief="solid")
    frame_left.grid(row=0, column=0, sticky="nsew", padx=5, pady=5)
    frame_main.grid_columnconfigure(0, weight=1)
    frame_main.grid_rowconfigure(0, weight=1)
    checklist = tk.Listbox(frame_left, height=16, selectmode=tk.EXTENDED, width=10)
    checklist.grid(row=0, column=0, columnspan=4, padx=10, pady=(10, 2), sticky="nsew")
    frame_left.grid_rowconfigure(0, weight=1)
    for i in range(4): frame_left.grid_columnconfigure(i, weight=1)
    tk.Button(frame_left, text="CSV ë¶ˆëŸ¬ì˜¤ê¸°", width=13, command=csv_import).grid(row=1, column=0, padx=2, pady=2,
                                                                              sticky="we")
    tk.Button(frame_left, text="ì„ íƒ ì£¼ì†Œ ì‚­ì œ", width=13, command=delete_selected).grid(row=2, column=0, padx=2, pady=2,
                                                                                   sticky="we")
    tk.Button(frame_left, text="ì£¼ì†Œ í‘œì¤€í™”", width=13, command=standardize_addresses).grid(row=3, column=0, padx=2, pady=2,
                                                                                       sticky="we")
    tk.Button(frame_left, text="ê¸°ì¡´ ì§€ë„ ë¶ˆëŸ¬ì˜¤ê¸°", width=13, command=load_map_from_html).grid(row=3, column=1, padx=2, pady=2,
                                                                                        sticky="we")
    tk.Button(frame_left, text="ì§€ë„ ìƒì„±", width=13, command=lambda: run_process("map")).grid(row=1, column=1, padx=2,
                                                                                           pady=2, sticky="we")
    tk.Button(frame_left, text="ì—‘ì…€ ì €ì¥", width=13, command=lambda: run_process("excel")).grid(row=2, column=1, padx=2,
                                                                                             pady=2, sticky="we")

    frame_right_container = tk.Frame(frame_main)
    frame_right_container.grid(row=0, column=1, sticky="nsew", padx=5, pady=5)
    frame_main.grid_columnconfigure(1, weight=2)
    frame_right = tk.LabelFrame(frame_right_container, text="ìŠ¤íƒ€ì¼ ì„¤ì • (ê¸°ë³¸ê°’)", bd=2, relief="solid", height=270)
    frame_right.pack(fill="x", pady=(0, 10))
    frame_right.pack_propagate(False)
    tk.Label(frame_right, text="ì„  ìƒ‰ìƒ").pack()
    tk.Button(frame_right, text="ì„  ìƒ‰ìƒ ì„ íƒ", width=13,
              command=lambda: stroke_color_var.set(colorchooser.askcolor(initialcolor=stroke_color_var.get())[1])).pack(
        pady=2)
    tk.Label(frame_right, text="ì±„ì›€ ìƒ‰ìƒ").pack()
    tk.Button(frame_right, text="ì±„ì›€ ìƒ‰ìƒ ì„ íƒ", width=13,
              command=lambda: fill_color_var.set(colorchooser.askcolor(initialcolor=fill_color_var.get())[1])).pack(
        pady=2)
    tk.Label(frame_right, text="ì±„ì›€ íˆ¬ëª…ë„ (0.0 ~ 1.0)").pack()
    tk.Entry(frame_right, textvariable=fill_opacity_var, width=13).pack(pady=(0, 5))
    tk.Button(frame_right, text="ì„ íƒ ì£¼ì†Œ ìŠ¤íƒ€ì¼ ì ìš©", width=13, command=apply_style_to_selected).pack(pady=6)
    frame_guide = tk.LabelFrame(frame_right_container, text="ì‚¬ìš©ë²•", bd=2, relief="solid", height=80)
    frame_guide.pack(fill="both", expand=True)
    tk.Label(frame_guide, text="[ëŒ€ìš©ëŸ‰ ì•ˆì „ëª¨ë“œ]\n1. 10ê°œì”© ì²œì²œíˆ ì¡°íšŒí•©ë‹ˆë‹¤ (API ì°¨ë‹¨ ë°©ì§€)\n2. ëˆ„ë½ ì‹œ 3ë²ˆ ì¬ì‹œë„í•©ë‹ˆë‹¤.\n3. ì €ì¥ ì‹œ ì¤‘ë³µì„ ìë™ ì œê±°í•©ë‹ˆë‹¤.",
             justify="left").pack(anchor="w", padx=10, pady=5)

    root.mainloop()


if __name__ == "__main__":
    run_gui()
